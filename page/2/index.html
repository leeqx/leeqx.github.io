<!DOCTYPE html>



  


<html class="theme-next muse use-motion" lang="zh-Hans">
<head><meta name="generator" content="Hexo 3.8.0">
  <meta charset="UTF-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
<meta name="theme-color" content="#222">









<meta http-equiv="Cache-Control" content="no-transform">
<meta http-equiv="Cache-Control" content="no-siteapp">
















  
  
  <link href="/lib/fancybox/source/jquery.fancybox.css?v=2.1.5" rel="stylesheet" type="text/css">







<link href="/lib/font-awesome/css/font-awesome.min.css?v=4.6.2" rel="stylesheet" type="text/css">

<link href="/css/main.css?v=5.1.4" rel="stylesheet" type="text/css">


  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png?v=5.1.4">


  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png?v=5.1.4">


  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png?v=5.1.4">


  <link rel="mask-icon" href="/images/logo.svg?v=5.1.4" color="#222">





  <meta name="keywords" content="糊涂之至，方能致远!!">










<meta name="keywords" content="Linux Programs">
<meta property="og:type" content="website">
<meta property="og:title" content="linux programer">
<meta property="og:url" content="http://leeqx.github.io/page/2/index.html">
<meta property="og:site_name" content="linux programer">
<meta property="og:locale" content="zh-Hans">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="linux programer">



<script type="text/javascript" id="hexo.configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    root: '/',
    scheme: 'Muse',
    version: '5.1.4',
    sidebar: {"position":"left","display":"post","offset":12,"b2t":false,"scrollpercent":false,"onmobile":false},
    fancybox: true,
    tabs: true,
    motion: {"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},
    duoshuo: {
      userId: '0',
      author: '博主'
    },
    algolia: {
      applicationID: '',
      apiKey: '',
      indexName: '',
      hits: {"per_page":10},
      labels: {"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}
    }
  };
</script>



  <link rel="canonical" href="http://leeqx.github.io/page/2/">





  <title>linux programer</title>
  





  <script type="text/javascript">
    var _hmt = _hmt || [];
    (function() {
      var hm = document.createElement("script");
      hm.src = "https://hm.baidu.com/hm.js?true";
      var s = document.getElementsByTagName("script")[0];
      s.parentNode.insertBefore(hm, s);
    })();
  </script>




</head>

<body itemscope itemtype="http://schema.org/WebPage" lang="zh-Hans">

  
  
    
  

  <div class="container sidebar-position-left 
  page-home">
    <div class="headband"></div>

    <header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-wrapper">
  <div class="site-meta ">
    

    <div class="custom-logo-site-title">
      <a href="/" class="brand" rel="start">
        <span class="logo-line-before"><i></i></span>
        <span class="site-title">linux programer</span>
        <span class="logo-line-after"><i></i></span>
      </a>
    </div>
      
        <h1 class="site-subtitle" itemprop="description">不吝赐教</h1>
      
  </div>

  <div class="site-nav-toggle">
    <button>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
    </button>
  </div>
</div>

<nav class="site-nav">
  

  
    <ul id="menu" class="menu">
      
        
        <li class="menu-item menu-item-home">
          <a href="/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-home"></i> <br>
            
            首页
          </a>
        </li>
      
        
        <li class="menu-item menu-item-about">
          <a href="/about/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-user"></i> <br>
            
            关于
          </a>
        </li>
      
        
        <li class="menu-item menu-item-tags">
          <a href="/tags/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-tags"></i> <br>
            
            标签
          </a>
        </li>
      
        
        <li class="menu-item menu-item-categories">
          <a href="/categories/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-th"></i> <br>
            
            分类
          </a>
        </li>
      
        
        <li class="menu-item menu-item-archives">
          <a href="/archives/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-archive"></i> <br>
            
            归档
          </a>
        </li>
      
        
        <li class="menu-item menu-item-schedule">
          <a href="/schedule/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-calendar"></i> <br>
            
            日程表
          </a>
        </li>
      
        
        <li class="menu-item menu-item-sitemap">
          <a href="/sitemap.xml" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-sitemap"></i> <br>
            
            站点地图
          </a>
        </li>
      

      
    </ul>
  

  
</nav>



 </div>
    </header>

    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          <div id="content" class="content">
            
  <section id="posts" class="posts-expand">
    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://leeqx.github.io/2019/03/22/linux_进程死锁定位_端口无法连接/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Qinglin Li">
      <meta itemprop="description" content>
      <meta itemprop="image" content="https://avatars1.githubusercontent.com/u/931925?s=460&v=4">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="linux programer">
    </span>

    
      <header class="post-header">

        
        
          <h2 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2019/03/22/linux_进程死锁定位_端口无法连接/" itemprop="url">linux_进程死锁定位_端口无法连接</a></h2>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2019-03-22T11:39:01+08:00">
                2019-03-22
              </time>
            

            

            
          </span>

          
            <span class="post-category">
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/后台技术/" itemprop="url" rel="index">
                    <span itemprop="name">后台技术</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h2 id="linux-进程死锁定位"><a href="#linux-进程死锁定位" class="headerlink" title="linux 进程死锁定位"></a>linux 进程死锁定位</h2><blockquote>
<p>最近定位一个服务问题时发现telnet某个端口，无法链接。无奈之下只能一步步排查。  </p>
</blockquote>
<ol start="0">
<li>端口是否存在<br>ss -l|grep LISTEN|grep 9999  </li>
<li>如果端口存在那么可以观察该端口上的recv-q send-q 如果是发生死锁一般情况下这两个队列只会增加（当然当服务处理过慢时也会导致包堆积）  <figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">Recv-Q Send-Q           Local Address:Port               Peer Address:Port   </span><br><span class="line">0      1024              *:5200                         *:*       </span><br><span class="line">```  </span><br><span class="line">0. 另外可以通过一下命令统计各类socket 状态的数据  </span><br><span class="line">  ```shell</span><br><span class="line">ss |awk 'BEGIN&#123;arr[""]=0&#125;&#123;arr[$1]++&#125;END&#123;for(i in arr) print i,arr[i]&#125;'</span><br><span class="line">LAST-ACK 1305</span><br><span class="line">ESTAB 341643</span><br><span class="line">State 1</span><br><span class="line">FIN-WAIT-1 7553</span><br><span class="line">CLOSING 3</span><br><span class="line">FIN-WAIT-2 908</span><br><span class="line">CLOSE-WAIT 60067</span><br></pre></td></tr></table></figure>
</li>
</ol>
<p>如果你的服务是多个进程那么，如果只是一个进程死锁，那么很容易就可以看出来该进程的cpu消耗时间应该小于其他进程，当然这个取决于进程的运行时间。下面的进程中，id=1903的进程就是疑似死锁问题。  </p>
  <figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">root      1901     1  0 11:09 ?        00:00:00 ./client -f ../conf/client.ini -d</span><br><span class="line">root      1902  1901 15 11:09 ?        00:31:55 ./client -f ../conf/client.ini -d</span><br><span class="line">root      1903  1901  1 11:09 ?        00:02:25 ./client -f ../conf/client.ini -d</span><br><span class="line">root      1904  1901 15 11:09 ?        00:31:19 ./client -f ../conf/client.ini -d</span><br><span class="line">root      1905  1901 15 11:09 ?        00:31:17 ./client -f ../conf/client.ini -d</span><br></pre></td></tr></table></figure>
<ol start="0">
<li>定位哪里死锁<br>经过一步步盘查之后，怀疑进程死锁，ok。最好的定位方法就是attach到进程，然后bt一下既可以看到进程hang在哪里。。。<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash">gdb attach 1903</span></span><br><span class="line"><span class="meta">#</span><span class="bash">0  0x00007f105892105e <span class="keyword">in</span> __lll_lock_wait_private () from /lib64/libc.so.6</span></span><br><span class="line"><span class="meta">#</span><span class="bash">1  0x00007f10588c6cad <span class="keyword">in</span> _L_lock_2164 () from /lib64/libc.so.6</span></span><br><span class="line"><span class="meta">#</span><span class="bash">2  0x00007f10588c6a67 <span class="keyword">in</span> __tz_convert () from /lib64/libc.so.6</span></span><br><span class="line"><span class="meta">#</span><span class="bash">3  0x00007f105890da5d <span class="keyword">in</span> __vsyslog_chk () from /lib64/libc.so.6</span></span><br><span class="line"><span class="meta">#</span><span class="bash">4  0x00007f105889948e <span class="keyword">in</span> __libc_message () from /lib64/libc.so.6</span></span><br><span class="line"><span class="meta">#</span><span class="bash">5  0x00007f105889ee66 <span class="keyword">in</span> malloc_printerr () from /lib64/libc.so.6</span></span><br><span class="line"><span class="meta">#</span><span class="bash">6  0x00007f10588c6909 <span class="keyword">in</span> tzset_internal () from /lib64/libc.so.6</span></span><br><span class="line"><span class="meta">#</span><span class="bash">7  0x00007f10588c6a89 <span class="keyword">in</span> __tz_convert () from /lib64/libc.so.6</span></span><br><span class="line"><span class="meta">#</span><span class="bash">8  0x00000000004c0917 <span class="keyword">in</span> shift_fd (lvl=1, fmt=0x55e308 <span class="string">"[%s][%d][%s]: [server] recv SIGSEGV.pid:%d!\n"</span>) at ../src/log_xx.cpp:95</span></span><br><span class="line"><span class="meta">#</span><span class="bash">9  write_log (lvl=1, fmt=0x55e308 <span class="string">"[%s][%d][%s]: [server] recv SIGSEGV.pid:%d!\n"</span>) at ../src/log_xx.cpp:138</span></span><br></pre></td></tr></table></figure>
</li>
</ol>
<p>上面这个问题导致是因为进程抛出了SEGV信号之后，在处理信号的方法中使用了非线程安全的localtime，而该方法中会枷锁。 </p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://leeqx.github.io/2019/03/22/linux利用进程信息定位内存泄漏采用pmap/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Qinglin Li">
      <meta itemprop="description" content>
      <meta itemprop="image" content="https://avatars1.githubusercontent.com/u/931925?s=460&v=4">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="linux programer">
    </span>

    
      <header class="post-header">

        
        
          <h2 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2019/03/22/linux利用进程信息定位内存泄漏采用pmap/" itemprop="url">linux利用进程信息定位内存泄漏采用pmap</a></h2>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2019-03-22T11:39:01+08:00">
                2019-03-22
              </time>
            

            

            
          </span>

          
            <span class="post-category">
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/后台技术/" itemprop="url" rel="index">
                    <span itemprop="name">后台技术</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p><code>比如进程id:1381</code><br>由于带有虚拟函数的类实例在new时再内存heap中会有对应的虚函数表，所以我们可以通过这个切入点来分析heap中的各类实例的统计数，然后进一步根据实例的数量判断是否存在内存泄漏。</p>
<p>gdb attach 1381<br><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">(gdb) shellp pmap 1381</span><br><span class="line">(gdb) set height 0              ----自动，不需要手动</span><br><span class="line">(gdb) set logging on            ----开启调试写日志gdb.txt</span><br><span class="line">Copying output to gdb.txt.</span><br><span class="line">(gdb) x/13087744a 0x0000000001d6b000</span><br></pre></td></tr></table></figure></p>
<p>13087744a 表示打印13087744个地址，该值是由heap的大小计算出来的：1024*102248/8 (一个64位机器系统上的指针长度)</p>
<p>参考：<br><a href="http://m.blog.csdn.net/article/details?id=50504608" target="_blank" rel="noopener">利用进程信息gdb pmap进行内存泄漏定位</a></p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://leeqx.github.io/2019/03/22/linux服务器性能分析_TCP内存/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Qinglin Li">
      <meta itemprop="description" content>
      <meta itemprop="image" content="https://avatars1.githubusercontent.com/u/931925?s=460&v=4">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="linux programer">
    </span>

    
      <header class="post-header">

        
        
          <h2 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2019/03/22/linux服务器性能分析_TCP内存/" itemprop="url">linux服务器性能分析_TCP内存</a></h2>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2019-03-22T11:39:01+08:00">
                2019-03-22
              </time>
            

            

            
          </span>

          
            <span class="post-category">
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/后台技术/" itemprop="url" rel="index">
                    <span itemprop="name">后台技术</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h2 id="linux-服务器性能分析"><a href="#linux-服务器性能分析" class="headerlink" title="linux 服务器性能分析"></a>linux 服务器性能分析</h2><ol start="0">
<li>网络连接数<br>cat /proc/net/sockstat<br>或者ss 进行统计（比较慢）  </li>
<li><p>系统dmesg提示 socket out of memory</p>
<ol start="0">
<li>首先查看系统socket使用了多少，参考1.</li>
<li><p>查看系统给tcp分配的内存大小限制<br>cat /proc/sys/net/ipv4/tcp_rmem   #tcp read buffer bytes  </p>
<blockquote>
<p>4096  87380 629145<br>第一项是buffer最小4096字节，第二项是默认值87380字节，第三项是read buffer 最大限制629145 字节  </p>
</blockquote>
<p>cat /proc/sys/net/ipv4/tcp_wmem   #tcp write buffer bytes<br><em>write buffer与read buffer类似</em><br>cat /proc/sys/net/ipv4/tcp_mem    #tcp memory pages  </p>
<blockquote>
<p>21498 28665 42996<br>第一个值是内存使用的下限；第二个值是内存压力模式开始对缓冲区使用应用压力的上限；第三个值是内存使用的上限。在这个层次上可以将报文丢弃，从而减少对内存的使用socket out of memory。可以结合sockstat里的统计数据分析tcp使用内存是否超过了限制，注意这里单位是页，查看页大小getconf PAGESIZE<br>另外可以查看tcp读写发送窗口默认值：<br>/proc/sys/net/core/rmem_default<br>/proc/sys/net/core/rmem_max<br>/proc/sys/net/core/wmem_default<br>/proc/sys/net/core/wmem_max<br>另外socket out of memory 也有可能是孤儿socket过多导致的。<br>内核配置最大的孤儿socket数：<br>cat /proc/sys/net/ipv4/max_orphans<br>4096 </p>
</blockquote>
</li>
<li>查看孤儿socket<br>cat /proc/net/sockstat  <blockquote>
<p>sockets: used 403<br>TCP: inuse 4 orphan 0 tw 0 alloc 10 mem 1<br>UDP: inuse 12 mem 7<br>UDPLITE: inuse 0<br>RAW: infuse 0<br>FRAG: inuse 0 memory 0<br>注意这里的orphan 往往会被内核x2 或者x4，所以有时候看到这里的orphan数比较小，但是却有out of socket memory的提示，有可能就是这个放大倍数导致的。<br>关于孤儿socket 可以参考：<a href="http://www.aichengxu.com/view/2486870" target="_blank" rel="noopener">孤儿socket</a></p>
</blockquote>
</li>
</ol>
</li>
<li>一个tcp socket占用多大内存<br>首先socket包括本地ip、端口，对端ip、端口；发送、接收缓冲区等（跟配置有关）。<br>如果按照上面最小的读写缓冲区来算那么一个socket大概占用8K的内存。<br>如果单从一个socket占用的内存来看，一个8GB的内存，一般情况下可以承受100万得sock长连接，前提是系统文件句柄要调大<br>tcp内存最大也要进行调整。</li>
<li>tcp内核参数调优<br><a href="http://www.2cto.com/os/201304/205115.html" target="_blank" rel="noopener">tcp参数调优</a></li>
<li><p>查看系统总共使用了多少文件描述符<br>cat /proc/sys/fs/file-nr</p>
<blockquote>
<p>4096 0 9000<br>第一项就是当前系统已经打开的文件句柄（包括socket ）</p>
</blockquote>
<p>cat /proc/sys/fs/file-max<br>系统最大的文件句柄数</p>
</li>
<li>dmesg  or dmesg -T<br>查看内核的错误信息，比如tcp链接太多，句柄不够用，内存不足导致某些进程被kill掉</li>
<li>slabtop 内核内存分配</li>
<li>iostat -d 1 10 -x</li>
<li>vmstat -n 1 10<br>可以通过该命令动态观察swap内存是否在发生变化，如果一直在增长，那么可以初步断定系统内存不够用。</li>
<li>当cache、buffer占用大量内存是可以通过调整内核参数释放改内存：<br>$sync   (必须要先执行）<br>$ echo “3” &gt; /proc/sys/vm/drop_caches  (该值默认是0，不释放)  </li>
</ol>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://leeqx.github.io/2019/03/22/redis-dict字典/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Qinglin Li">
      <meta itemprop="description" content>
      <meta itemprop="image" content="https://avatars1.githubusercontent.com/u/931925?s=460&v=4">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="linux programer">
    </span>

    
      <header class="post-header">

        
        
          <h2 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2019/03/22/redis-dict字典/" itemprop="url">redis-dict字典</a></h2>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2019-03-22T11:39:01+08:00">
                2019-03-22
              </time>
            

            

            
          </span>

          
            <span class="post-category">
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/后台技术/" itemprop="url" rel="index">
                    <span itemprop="name">后台技术</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h1 id="redis-dict"><a href="#redis-dict" class="headerlink" title="redis dict"></a>redis dict</h1><p>　　redis 数据库结构是通过dict 字典来完成的。该dict数据结构如下：<br>  <figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> <span class="title">dictEntry</span> &#123;</span> <span class="keyword">void</span>*key;                                                                                                         <span class="keyword">union</span> &#123;                                                              </span><br><span class="line">    <span class="keyword">void</span> *val;                                                                 </span><br><span class="line">    <span class="keyword">uint64_t</span> u64;</span><br><span class="line">    <span class="keyword">int64_t</span> s64;  </span><br><span class="line">    <span class="keyword">double</span> d;</span><br><span class="line">  &#125;v;</span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">dictEntry</span> *<span class="title">next</span>;</span>                                                       </span><br><span class="line">&#125; dictEntry;   </span><br><span class="line"></span><br><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> <span class="title">dictht</span> &#123;</span>                                                                                            </span><br><span class="line">      dictEntry **table;  <span class="comment">//数组存放指针                                                                </span></span><br><span class="line">      <span class="keyword">unsigned</span> <span class="keyword">long</span> size;                                                                                            </span><br><span class="line">      <span class="keyword">unsigned</span> <span class="keyword">long</span> sizemask;                                                                                        </span><br><span class="line">      <span class="keyword">unsigned</span> <span class="keyword">long</span> used;                                                                                             </span><br><span class="line">   &#125; dictht;                                                                                                         </span><br><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> <span class="title">dict</span> &#123;</span>                                                                                             </span><br><span class="line">     dictType *type; </span><br><span class="line">     <span class="keyword">void</span> *privdata;                                                                                                 </span><br><span class="line">     dictht ht[<span class="number">2</span>];                                                                                                   </span><br><span class="line">     <span class="keyword">long</span> rehashidx; <span class="comment">/* rehashing not in progress if rehashidx == -1 */</span>                                             </span><br><span class="line">     <span class="keyword">int</span> iterators; <span class="comment">/* number of iterators currently running */</span>                                                     </span><br><span class="line">  &#125; dict;</span><br></pre></td></tr></table></figure></p>
<p>从上面的数据结构的定义可以发现，ht[0].table ht[1].table 是用来实际存储数据的，它存储的逻辑也是根据ｈａｓｈ函数计算出来的值然后与ht[0］的ｓｉｚｅ中相与来决定具体的位置。这里为什么使用ht[2]呢？我们都知道在ｈａｓｈ种免不了碰撞的ｋｅｙ，所以随着数据的增长，每个ｂｕｃｋｅｔ中的碰撞ｋｅｙ也会越来越多，当达到一定的量级之后将会影响查询效率。这个时候另外一个ｈｔ就可以排上用场了。<br>　　当正在使用的ｈｔ[x]ｋｅｙ数达到一定的阈值之后，将会出发ｒｅｄｉｓ的ｒｅｈａｓｈ操作，该操作主要是新分配一个更大的或者更小的dictht然后，假定目前正在使用的是ｈｔ[0] 那么新分配的应该是位于ｈｔ［1]。然后循序渐进的讲数据从ｈｔ[0]慢慢的迁移到ht[1]：计算新的ｈａｓｈ、与ｓｉｚｅ与得到ｋｅｙ的ｉｎｄｅｘ。重复操作之后该ｄｉｃｔ的数据将趋于平衡。<br>  <figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/* Performs N steps of incremental rehashing. Returns 1 if there are still</span></span><br><span class="line"><span class="comment"> * keys to move from the old to the new hash table, otherwise 0 is returned.</span></span><br><span class="line"><span class="comment"> * Note that a rehashing step consists in moving a bucket (that may have more</span></span><br><span class="line"><span class="comment"> * than one key as we use chaining) from the old to the new hash table. */</span></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">dictRehash</span><span class="params">(dict *d, <span class="keyword">int</span> n)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (!dictIsRehashing(d)) <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">while</span>(n--) &#123;</span><br><span class="line">        dictEntry *de, *nextde;</span><br><span class="line"></span><br><span class="line">        <span class="comment">/* Check if we already rehashed the whole table... */</span></span><br><span class="line">        <span class="keyword">if</span> (d-&gt;ht[<span class="number">0</span>].used == <span class="number">0</span>) &#123;</span><br><span class="line">            zfree(d-&gt;ht[<span class="number">0</span>].table);</span><br><span class="line">            d-&gt;ht[<span class="number">0</span>] = d-&gt;ht[<span class="number">1</span>];</span><br><span class="line">            _dictReset(&amp;d-&gt;ht[<span class="number">1</span>]);</span><br><span class="line">            d-&gt;rehashidx = <span class="number">-1</span>;</span><br><span class="line">            <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">/* Note that rehashidx can't overflow as we are sure there are more</span></span><br><span class="line"><span class="comment">         * elements because ht[0].used != 0 */</span></span><br><span class="line">        assert(d-&gt;ht[<span class="number">0</span>].size &gt; (<span class="keyword">unsigned</span> <span class="keyword">long</span>)d-&gt;rehashidx);</span><br><span class="line">        <span class="keyword">while</span>(d-&gt;ht[<span class="number">0</span>].table[d-&gt;rehashidx] == <span class="literal">NULL</span>) d-&gt;rehashidx++;</span><br><span class="line">        de = d-&gt;ht[<span class="number">0</span>].table[d-&gt;rehashidx];</span><br><span class="line">        <span class="comment">/* Move all the keys in this bucket from the old to the new hash HT */</span></span><br><span class="line">        <span class="keyword">while</span>(de) &#123;</span><br><span class="line">            <span class="keyword">unsigned</span> <span class="keyword">int</span> h;</span><br><span class="line"></span><br><span class="line">            nextde = de-&gt;next;</span><br><span class="line">            <span class="comment">/* Get the index in the new hash table */</span></span><br><span class="line">            h = dictHashKey(d, de-&gt;key) &amp; d-&gt;ht[<span class="number">1</span>].sizemask;</span><br><span class="line">            de-&gt;next = d-&gt;ht[<span class="number">1</span>].table[h];</span><br><span class="line">            d-&gt;ht[<span class="number">1</span>].table[h] = de;</span><br><span class="line">            d-&gt;ht[<span class="number">0</span>].used--;</span><br><span class="line">            d-&gt;ht[<span class="number">1</span>].used++;</span><br><span class="line">            de = nextde;</span><br><span class="line">        &#125;</span><br><span class="line">        d-&gt;ht[<span class="number">0</span>].table[d-&gt;rehashidx] = <span class="literal">NULL</span>;</span><br><span class="line">        d-&gt;rehashidx++;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line">&#125;</span><br><span class="line">     <span class="number">1</span> <span class="comment">/* Expand or create the hash table */</span>                                                                          </span><br><span class="line">     <span class="number">2</span> <span class="function"><span class="keyword">int</span> <span class="title">dictExpand</span><span class="params">(dict *d, <span class="keyword">unsigned</span> <span class="keyword">long</span> size)</span>                                                               </span></span><br><span class="line"><span class="function">     3 </span>&#123;                                                                                                              </span><br><span class="line">     <span class="number">4</span>     dictht n; <span class="comment">/* the new hash table */</span>                                                                        </span><br><span class="line">     <span class="number">5</span>     <span class="keyword">unsigned</span> <span class="keyword">long</span> realsize = _dictNextPower(size);                                                               </span><br><span class="line">     <span class="number">6</span>                                                                                                                </span><br><span class="line">     <span class="number">7</span>     <span class="comment">/* the size is invalid if it is smaller than the number of                                                 </span></span><br><span class="line"><span class="comment">     8     ¦* elements already inside the hash table */</span>                                                               </span><br><span class="line">     <span class="number">9</span>     <span class="keyword">if</span> (dictIsRehashing(d) || d-&gt;ht[<span class="number">0</span>].used &gt; size)                                                            </span><br><span class="line">    <span class="number">10</span>     ¦   <span class="keyword">return</span> DICT_ERR;</span><br><span class="line">　　<span class="number">11</span>               </span><br><span class="line">    <span class="number">12</span>     <span class="comment">/* Allocate the new hash table and initialize all pointers to NULL */</span>             </span><br><span class="line">    <span class="number">13</span>     n.size = realsize;                                                                                     </span><br><span class="line">    <span class="number">14</span>     n.sizemask = realsize<span class="number">-1</span>;                                                                                   </span><br><span class="line">✗   <span class="number">15</span>     n.table = zcalloc(realsize*<span class="keyword">sizeof</span>(dictEntry*));                                                            </span><br><span class="line">    <span class="number">16</span>     n.used = <span class="number">0</span>; </span><br><span class="line">　　　<span class="number">17</span>                                                                                     </span><br><span class="line">    <span class="number">18</span>     <span class="comment">/* Is this the first initialization? If so it's not really a rehashing             </span></span><br><span class="line"><span class="comment">    19     ¦* we just set the first hash table so that it can accept keys. */</span></span><br><span class="line">    <span class="number">20</span>     <span class="keyword">if</span> (d-&gt;ht[<span class="number">0</span>].table == <span class="literal">NULL</span>) &#123;                                                </span><br><span class="line">    <span class="number">21</span>     ¦   d-&gt;ht[<span class="number">0</span>] = n;                                                                                          </span><br><span class="line">    <span class="number">22</span>     ¦   <span class="keyword">return</span> DICT_OK;</span><br><span class="line">    <span class="number">23</span>     &#125;   </span><br><span class="line">　　<span class="number">24</span>                                   </span><br><span class="line">    <span class="number">25</span>     <span class="comment">/* Prepare a second hash table for incremental rehashing */</span>                                                </span><br><span class="line">    <span class="number">26</span>     d-&gt;ht[<span class="number">1</span>] = n;      </span><br><span class="line">    <span class="number">27</span>     d-&gt;rehashidx = <span class="number">0</span>;       </span><br><span class="line">    <span class="number">28</span>     <span class="keyword">return</span> DICT_OK;</span><br><span class="line">    <span class="number">29</span> &#125;</span><br></pre></td></tr></table></figure></p>
<h2 id="查找key"><a href="#查找key" class="headerlink" title="查找ｋｅｙ"></a>查找ｋｅｙ</h2>  <figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">dictEntry *<span class="title">dictFind</span><span class="params">(dict *d, <span class="keyword">const</span> <span class="keyword">void</span> *key)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    dictEntry *he;</span><br><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">int</span> h, idx, table;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (d-&gt;ht[<span class="number">0</span>].size == <span class="number">0</span>) <span class="keyword">return</span> <span class="literal">NULL</span>; <span class="comment">/* We don't have a table at all */</span></span><br><span class="line">    <span class="keyword">if</span> (dictIsRehashing(d)) _dictRehashStep(d);</span><br><span class="line">    h = dictHashKey(d, key);</span><br><span class="line">    <span class="keyword">for</span> (table = <span class="number">0</span>; table &lt;= <span class="number">1</span>; table++) &#123;</span><br><span class="line">        idx = h &amp; d-&gt;ht[table].sizemask;</span><br><span class="line">        he = d-&gt;ht[table].table[idx];</span><br><span class="line">        <span class="keyword">while</span>(he) &#123;</span><br><span class="line">            <span class="keyword">if</span> (dictCompareKeys(d, key, he-&gt;key))</span><br><span class="line">                <span class="keyword">return</span> he;</span><br><span class="line">            he = he-&gt;next;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (!dictIsRehashing(d)) <span class="keyword">return</span> <span class="literal">NULL</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">NULL</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://leeqx.github.io/2019/03/22/stdcall_cdecl/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Qinglin Li">
      <meta itemprop="description" content>
      <meta itemprop="image" content="https://avatars1.githubusercontent.com/u/931925?s=460&v=4">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="linux programer">
    </span>

    
      <header class="post-header">

        
        
          <h2 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2019/03/22/stdcall_cdecl/" itemprop="url">stdcall_cdecl</a></h2>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2019-03-22T11:39:01+08:00">
                2019-03-22
              </time>
            

            

            
          </span>

          
            <span class="post-category">
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/后台技术/" itemprop="url" rel="index">
                    <span itemprop="name">后台技术</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h1 id="stdcall-与-cdecl的区别"><a href="#stdcall-与-cdecl的区别" class="headerlink" title="_stdcall 与 _cdecl的区别"></a><code>_stdcall</code> 与 <code>_cdecl</code>的区别</h1><p>首先，需要了解两者之间的区别：<br>WINDOWS的函数调用时需要用到栈（STACK，一种先入后出的存储结构）。当函数调用完成后<br>，栈需要清除，这里就是问题的关键，如何清除？？如果我们的函数使用了_cdecl，那么栈的<br>清除工作是由调用者，用COM的术语来讲就是客户来完成的。这样带来了一个棘手的问题，<br>不同的编译器产生栈的方式不尽相同，那么调用者能否正常的完成清除工作呢？答案是不能。<br>如果使用<strong>stdcall，上面的问题就解决了，函数自己解决清除工作。所以，在跨（开发）<br>平台的调用中，我们都使用</strong>stdcall（虽然有时是以WINAPI的样子出现）。<br>那么为什么还需要_cdecl呢？当我们遇到这样的函数如fprintf()它的参数是可变的，<br>不定长的，被调用者事先无法知道参数的长度，事后的清除工作也无法正常的进行，<br>因此，这种情况我们只能使用_cdecl。到这里我们有一个结论，如果你的程序中没有涉及<br>可变参数，最好使用__stdcall关键字。  </p>
<p>另：<br><code>_cdecl</code><br>按从右至左的顺序压参数入栈，由调用者把参数弹出栈。对于“C”函数或者变量，修饰名是在函数名前加下划线。<br>对于“C++”函数，有所不同。<br>如函数<code>void test(void)的修饰名是_test；</code>对于不属于一个类的“C++”全局函数，修饰名是?test@@ZAXXZ。<br>这是MFC缺省调用约定。由于是调用者负责把参数弹出栈，所以可以给函数定义个数不定的参数，如printf函数。  </p>
<p>stdcall 和pascal一样,都是pascal的调用习惯<br>按从右至左的顺序压参数入栈，由被调用者把参数弹出栈。对于“C”函数或者变量，修饰名以下划线为前缀，<br>然后是函数名，然后是符号“@”及参数的字节数，如函数int func(int a, double b)的修饰名是_func@12。<br>对于“C++”函数，则有所不同。  </p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://leeqx.github.io/2019/03/22/tcpburn-压测/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Qinglin Li">
      <meta itemprop="description" content>
      <meta itemprop="image" content="https://avatars1.githubusercontent.com/u/931925?s=460&v=4">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="linux programer">
    </span>

    
      <header class="post-header">

        
        
          <h2 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2019/03/22/tcpburn-压测/" itemprop="url">tcpburn-压测</a></h2>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2019-03-22T11:39:01+08:00">
                2019-03-22
              </time>
            

            

            
          </span>

          
            <span class="post-category">
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/后台技术/" itemprop="url" rel="index">
                    <span itemprop="name">后台技术</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h2 id="安装"><a href="#安装" class="headerlink" title="安装"></a>安装</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">yum install libpcap libpcap-devel</span><br><span class="line"></span><br><span class="line">cd tcpcopy-0.9.9</span><br><span class="line">make clean</span><br><span class="line">sh autogen.sh</span><br><span class="line">./configure --enable-single --enable-pcap --enable-advanced</span><br><span class="line">make </span><br><span class="line">make install</span><br><span class="line"></span><br><span class="line">cd ../tcpburn</span><br><span class="line">make clean</span><br><span class="line"><span class="meta">#</span><span class="bash">./configure --single  </span></span><br><span class="line">./configure --single  --comet</span><br><span class="line">make</span><br><span class="line">make install</span><br></pre></td></tr></table></figure>
<h2 id="配置"><a href="#配置" class="headerlink" title="配置"></a>配置</h2><p>tcpburn 按照如下配置intercept 服务可以和tcpburn部署在同一台机器上，另外需要注意的是目标服务与tcpburn、intercept必须在同一个网段。<br>start.sh<br><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br></pre></td><td class="code"><pre><span class="line">killall intercept</span><br><span class="line">killall intercept</span><br><span class="line">rm ./logs/*.log*</span><br><span class="line"></span><br><span class="line">sleep 2</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash">intercept server</span></span><br><span class="line">intercept_server=11.aa.xx.80</span><br><span class="line">intercept_port=36524</span><br><span class="line"><span class="meta">#</span><span class="bash">our <span class="built_in">test</span> service</span></span><br><span class="line">target_server=11.aa.xx.79</span><br><span class="line">target_port=14000</span><br><span class="line">tcpdump_port=14000</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash">generate by tcpdump -s 0 port 80(your port) -i any -w 80.cap</span></span><br><span class="line">cap_file=client_access_2.0.cap</span><br><span class="line">client_net_range=62.135.250.x</span><br><span class="line">route_net=`echo $client_net_range|awk -F'.' '&#123;print $1"."$2".0.0"&#125;'`</span><br><span class="line">intercept_filter_net=`echo $client_net_range|awk -F'.' '&#123;print $1"."$2"."$3".0"&#125;'`</span><br><span class="line"></span><br><span class="line">echo "###################################################################################"</span><br><span class="line">echo "#intercept install on $intercept_server"</span><br><span class="line">echo "#target_server  install on $intercept_server ,such as(client_access\setlogic)"</span><br><span class="line">echo "#run this command on $target_server"</span><br><span class="line">echo "# route add -net $route_net netmask 255.255.0.0 gw $intercept_server"</span><br><span class="line">echo "# for delete runing:"</span><br><span class="line">echo "# route del -net $route_net netmask 255.255.0.0 gw $intercept_server"</span><br><span class="line">echo "#use tcpdump to capture packet on realserver,eg:"</span><br><span class="line">echo "#    tcpdump -s 0 port $tcpdump_port -i any -w $cap_file"</span><br><span class="line">echo "#"</span><br><span class="line">echo "# use this command to run tcpburn:"</span><br><span class="line">echo "#./tcpburn/objs/tcpburn -x $tcpdump_port-$target_server:$target_port -f $cap_file -s $intercept_server -p $intercept_port -u 100 -c $client_net_range"</span><br><span class="line">echo "###################################################################################"</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash">1. <span class="built_in">set</span> route on target server</span></span><br><span class="line"><span class="meta">#</span><span class="bash">eg:</span></span><br><span class="line"><span class="meta">#</span><span class="bash">Assume 65.135.233.161 is the IP address of the assistant server. We <span class="built_in">set</span> the following</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> route commands to route all responses to the 62.135.200.x<span class="string">'s clients to the assistant</span></span></span><br><span class="line"><span class="meta">#</span><span class="bash"> server.</span></span><br><span class="line"><span class="meta">#</span><span class="bash">add:</span></span><br><span class="line"><span class="meta">#</span><span class="bash">  route add -net 62.135.200.0 netmask 255.255.255.0 gw 65.135.233.161</span></span><br><span class="line"><span class="meta">#</span><span class="bash">delete:</span></span><br><span class="line"><span class="meta">#</span><span class="bash">  route  -net 62.135.200.0 netmask 255.255.255.0 gw 65.135.233.161</span></span><br><span class="line"><span class="meta">#</span><span class="bash">run this on targe sever:such as on  execute:</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> add route to intercept server(11.aa.xx.79)</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> net 62.135.0.0 must match the client ips at tcpburn option -c here is <span class="string">"62.135.250.x"</span></span></span><br><span class="line"><span class="meta">#</span><span class="bash">       route add -net `<span class="built_in">echo</span> <span class="variable">$client_net_range</span>|awk -F<span class="string">'.'</span> <span class="string">'&#123;print $1"."$2".0.0"&#125;'</span> netmask 255.255.0.0 gw <span class="variable">$intercept_server</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash">2.start intercept </span></span><br><span class="line"><span class="meta">#</span><span class="bash"><span class="string">"src port 80"</span> is match with tcpdump capture</span></span><br><span class="line"><span class="meta">#</span><span class="bash">eg:</span></span><br><span class="line"><span class="meta">#</span><span class="bash">intercept -i eth1 -F <span class="string">"src port 80 and net 62.135.250.0/24"</span> -b 11.aa.xx.79  -d</span></span><br><span class="line"><span class="meta">#</span><span class="bash">intercept -i eth1 -F <span class="string">"src port 80 "</span> -b 11.aa.xx.79  -d</span></span><br><span class="line">echo intercept -i eth1 -F \"src port $target_port and net $intercept_filter_net/24\"  -d</span><br><span class="line"><span class="meta">#</span><span class="bash">intercept -i eth1 -F <span class="string">"src port <span class="variable">$target_port</span> and net <span class="variable">$intercept_filter_net</span>/24"</span>  -d</span></span><br><span class="line">intercept -i eth1 -F "src port $target_port and net $intercept_filter_net/24"  -d</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash">3. start tcpburn to send request to target server throught intercept</span></span><br><span class="line"><span class="meta">#</span><span class="bash">eg:</span></span><br><span class="line"><span class="meta">#</span><span class="bash">Assume 65.135.233.160 is the IP address of the target server and 11.aa.xx.79 is the</span></span><br><span class="line"><span class="meta">#</span><span class="bash">internal IP address of the assistant server and 65.135.233.161 is the external IP </span></span><br><span class="line"><span class="meta">#</span><span class="bash">address of the assistant server.</span></span><br><span class="line"><span class="meta">#</span><span class="bash">  ./tcpburn -x 80-65.135.233.160:80 -f /path/to/80.pcap -s 11.aa.xx.79 </span></span><br><span class="line"><span class="meta">#</span><span class="bash">   -u 10000 -c 62.135.200.x</span></span><br><span class="line">sleep 5</span><br><span class="line">netstat -anp|grep $intercept_port</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash">file <span class="variable">$cap_file</span> is tcpdump: tcpdump -s 0 dst port <span class="variable">$tcpdump_port</span> -i any -c 1000000 -w <span class="variable">$cap_file</span></span></span><br><span class="line">echo ./tcpburn/objs/tcpburn -x $tcpdump_port-$target_server:$target_port -f $cap_file -s $intercept_server -p $intercept_port -u 100 -c $client_net_range</span><br><span class="line">echo "tcpburn log on /usr/local/tcpburn/logs"</span><br><span class="line">./tcpburn/objs/tcpburn -x $tcpdump_port-$target_server:$target_port -f $cap_file -s $intercept_server -p $intercept_port -u 100 -c $client_net_range</span><br></pre></td></tr></table></figure></p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://leeqx.github.io/2019/03/22/C数组内存分布/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Qinglin Li">
      <meta itemprop="description" content>
      <meta itemprop="image" content="https://avatars1.githubusercontent.com/u/931925?s=460&v=4">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="linux programer">
    </span>

    
      <header class="post-header">

        
        
          <h2 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2019/03/22/C数组内存分布/" itemprop="url">C数组内存分布</a></h2>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2019-03-22T11:39:01+08:00">
                2019-03-22
              </time>
            

            

            
          </span>

          
            <span class="post-category">
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/后台技术/" itemprop="url" rel="index">
                    <span itemprop="name">后台技术</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h1 id="数组内存中分布情况"><a href="#数组内存中分布情况" class="headerlink" title="数组内存中分布情况"></a>数组内存中分布情况</h1><ol start="0">
<li>二维数组<br>注意栈中地址是从高地址向低地址生长：  </li>
</ol>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line">(gdb) p/x &amp;arr[<span class="number">0</span>][<span class="number">0</span>]</span><br><span class="line">$<span class="number">7</span> = <span class="number">0x7fffffffe440</span></span><br><span class="line">(gdb) p/x &amp;arr[<span class="number">0</span>][<span class="number">1</span>]</span><br><span class="line">$<span class="number">8</span> = <span class="number">0x7fffffffe444</span></span><br><span class="line">(gdb) p/x &amp;arr[<span class="number">0</span>][<span class="number">2</span>]</span><br><span class="line">$<span class="number">9</span> = <span class="number">0x7fffffffe448</span></span><br><span class="line">(gdb) p/x &amp;arr[<span class="number">0</span>][<span class="number">3</span>]</span><br><span class="line">$<span class="number">10</span> = <span class="number">0x7fffffffe44c</span></span><br><span class="line"></span><br><span class="line">(gdb) p/x &amp;arr[<span class="number">1</span>][<span class="number">0</span>]</span><br><span class="line">$<span class="number">11</span> = <span class="number">0x7fffffffe450</span></span><br><span class="line">(gdb) p/x &amp;arr[<span class="number">1</span>][<span class="number">1</span>]</span><br><span class="line">$<span class="number">12</span> = <span class="number">0x7fffffffe454</span></span><br><span class="line">(gdb) p/x &amp;arr[<span class="number">1</span>][<span class="number">2</span>]</span><br><span class="line">$<span class="number">13</span> = <span class="number">0x7fffffffe458</span></span><br><span class="line">(gdb) p/x &amp;arr[<span class="number">1</span>][<span class="number">3</span>]</span><br><span class="line">$<span class="number">14</span> = <span class="number">0x7fffffffe45c</span></span><br><span class="line"></span><br><span class="line">(gdb) p/x &amp;arr[<span class="number">2</span>][<span class="number">0</span>]</span><br><span class="line">$<span class="number">15</span> = <span class="number">0x7fffffffe460</span></span><br><span class="line">(gdb) p/x &amp;arr[<span class="number">2</span>][<span class="number">1</span>]</span><br><span class="line">$<span class="number">16</span> = <span class="number">0x7fffffffe464</span></span><br><span class="line">(gdb) p/x &amp;arr[<span class="number">2</span>][<span class="number">2</span>]</span><br><span class="line">$<span class="number">17</span> = <span class="number">0x7fffffffe468</span></span><br><span class="line">(gdb) p/x &amp;arr[<span class="number">2</span>][<span class="number">3</span>]</span><br><span class="line">$<span class="number">18</span> = <span class="number">0x7fffffffe46c</span></span><br><span class="line"></span><br><span class="line">(gdb) p/x &amp;arr[<span class="number">3</span>][<span class="number">0</span>]</span><br><span class="line">$<span class="number">19</span> = <span class="number">0x7fffffffe470</span></span><br><span class="line">(gdb) p/x &amp;arr[<span class="number">3</span>][<span class="number">1</span>]</span><br><span class="line">$<span class="number">20</span> = <span class="number">0x7fffffffe474</span></span><br><span class="line">(gdb) p/x &amp;arr[<span class="number">3</span>][<span class="number">2</span>]</span><br><span class="line">$<span class="number">21</span> = <span class="number">0x7fffffffe478</span></span><br><span class="line">(gdb) p/x &amp;arr[<span class="number">3</span>][<span class="number">3</span>]</span><br><span class="line">$<span class="number">22</span> = <span class="number">0x7fffffffe47c</span></span><br></pre></td></tr></table></figure>
<p>即如下图走向：<br><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">         <span class="number">0</span>     <span class="number">1</span>     <span class="number">2</span>    <span class="number">3</span>  </span><br><span class="line">    <span class="number">0</span>  -------------------&gt;  </span><br><span class="line">    <span class="number">1</span>  -------------------&gt;  </span><br><span class="line">    <span class="number">2</span>  -------------------&gt;  </span><br><span class="line">    <span class="number">3</span>  -------------------&gt;  </span><br><span class="line">```  </span><br><span class="line"><span class="number">0.</span> 一维数组在内存中的分布情况：</span><br><span class="line">```c</span><br><span class="line">(gdb) p/x &amp;a[<span class="number">0</span>]                             </span><br><span class="line">$<span class="number">1</span> = <span class="number">0x7fffffffe460</span></span><br><span class="line">(gdb) p/x &amp;a[<span class="number">1</span>]</span><br><span class="line">$<span class="number">2</span> = <span class="number">0x7fffffffe464</span></span><br><span class="line">(gdb) p/x &amp;a[<span class="number">2</span>]</span><br><span class="line">$<span class="number">3</span> = <span class="number">0x7fffffffe468</span></span><br><span class="line">(gdb) p/x &amp;a[<span class="number">3</span>]</span><br><span class="line">$<span class="number">4</span> = <span class="number">0x7fffffffe46c</span></span><br><span class="line">(gdb) p/x &amp;a[<span class="number">4</span>]</span><br><span class="line">$<span class="number">5</span> = <span class="number">0x7fffffffe470</span></span><br><span class="line">(gdb) p/x &amp;a[<span class="number">5</span>]</span><br><span class="line">$<span class="number">6</span> = <span class="number">0x7fffffffe474</span></span><br></pre></td></tr></table></figure></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">低地址            高地址</span><br><span class="line">a  <span class="number">0</span>    <span class="number">1</span>    <span class="number">2</span>    <span class="number">3</span>     <span class="number">4</span></span><br><span class="line">    ---------------------&gt;</span><br></pre></td></tr></table></figure>
<ol start="0">
<li><p>c中栈是由高地址向低地址延伸,堆则是从低地址想高地址延伸</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">  栈底</span><br><span class="line">___________</span><br><span class="line">|     a[<span class="number">5</span>]     |     高地址</span><br><span class="line">|     a[<span class="number">4</span>]     |</span><br><span class="line">|     a[<span class="number">3</span>]     |</span><br><span class="line">|     a[<span class="number">2</span>]     |</span><br><span class="line">|     a[<span class="number">1</span>]     |</span><br><span class="line">|     a[<span class="number">0</span>]     |      低地址 </span><br><span class="line">      栈顶</span><br></pre></td></tr></table></figure>
</li>
<li><p>C程序内存中的组织形式     </p>
</li>
</ol>
<pre><code class="c">【代码区    】  高地址
【静态数据区 】
【栈        】
 -----------
 -----------
 -----------
 -----------
【 堆       】 低地址
</code></pre>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://leeqx.github.io/2019/03/22/共享内存操作/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Qinglin Li">
      <meta itemprop="description" content>
      <meta itemprop="image" content="https://avatars1.githubusercontent.com/u/931925?s=460&v=4">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="linux programer">
    </span>

    
      <header class="post-header">

        
        
          <h2 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2019/03/22/共享内存操作/" itemprop="url">共享内存操作</a></h2>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2019-03-22T11:39:01+08:00">
                2019-03-22
              </time>
            

            

            
          </span>

          
            <span class="post-category">
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/后台技术/" itemprop="url" rel="index">
                    <span itemprop="name">后台技术</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h1 id="C共享内存"><a href="#C共享内存" class="headerlink" title="C共享内存"></a>C共享内存</h1><ol start="0">
<li><p>ftok —&gt;文件到key，保证唯一性，存放在keys中，并且通过下面的方法将对应的字符串设置到进程的环境变量中，<br>以便fork出来的进程的可以访问这些环境变量：  </p>
 <figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">i = setenv(env_strings[apptype],envstr,<span class="number">1</span>);</span><br></pre></td></tr></table></figure>
</li>
<li><p>获取shm_id  </p>
 <figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">shm_id = shmget (keys[apptype],<span class="keyword">sizeof</span>(struct mem_blk),IPC_CREAT| IPC_EXCL|<span class="number">0x1ff</span>);</span><br></pre></td></tr></table></figure>
</li>
<li><p>更改shm_id相关的属性   </p>
 <figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">shmctl(shm_id,IPC_STAT,&amp;shmbuf);</span><br><span class="line">shmbuf.shm_perm.mode &amp;= SHM_R| SHM_W;</span><br><span class="line">shmctl(shm_id,IPC_SET,&amp;shmbuf);</span><br></pre></td></tr></table></figure>
</li>
<li><p>获取相应的共享内存，并且初始化共享内存为0 </p>
 <figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">pshm = (<span class="keyword">int8_t</span>*)shmat(shm_id,<span class="literal">NULL</span>,<span class="number">0</span>);</span><br></pre></td></tr></table></figure>
</li>
<li><p>共享内存的删除：  </p>
 <figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">shmctl(shm_id, IPC_RMID, <span class="number">0</span>)</span><br></pre></td></tr></table></figure>
</li>
<li><p>（在其他进程子进程）连接共享内存：</p>
 <figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">envstr = getenv(env_strings[apptype]);</span><br><span class="line">shm_id = atoi(envstr);</span><br><span class="line">pshm = ( <span class="keyword">int8_t</span>*)shmat(shm_id,<span class="literal">NULL</span>,<span class="number">0</span>);</span><br></pre></td></tr></table></figure>
</li>
<li><p>共享内存的读写：<br>通过6得到的pshm共享内存指针就可以往该共享内存块上进行读写</p>
</li>
<li><p>共享内存操作命令：ipcs、ipcrm</p>
<ol start="0">
<li>ipcs -m 显示共享内存：<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">------ Shared Memory Segments --------  </span><br><span class="line">key        shmid      owner      perms      bytes      nattch     status        </span><br><span class="line">0x740180a7 2686976    root      600        4          0                         </span><br><span class="line">0x740a800c 3642337    root      600        4          0                           </span><br><span class="line">0x00000000 5644578    nobody    600        16777216   129        dest         </span><br><span class="line">0x740aa00b 3609571    root      600        4          0                       </span><br><span class="line">0x00000000 5677348    nobody    600        16777216   257        dest         </span><br><span class="line">0x00000000 5660117    nobody    600        16777216   257        dest         </span><br><span class="line">0x00000bde 5642887    root      666        63120208   1</span><br></pre></td></tr></table></figure>
</li>
</ol>
<p>字段|说明<br>—-|—-<br>key |是用来唯一标识这段共享内存的唯一标示；<br>shmid|是shmget返回的共享内存id；<br>owner|创建共享内存的用户<br>perms|读写权限<br>Bytes|标示key这段共享内存大小<br>nattach|表示attch到这段共享内存的数量</p>
<ol start="0">
<li>ipcrm -m shmid removes the shared memory segment identified by shmid after the last detach is performed.</li>
</ol>
</li>
</ol>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://leeqx.github.io/2019/03/22/利用tcpburn进行长连接压测、现网流量压测/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Qinglin Li">
      <meta itemprop="description" content>
      <meta itemprop="image" content="https://avatars1.githubusercontent.com/u/931925?s=460&v=4">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="linux programer">
    </span>

    
      <header class="post-header">

        
        
          <h2 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2019/03/22/利用tcpburn进行长连接压测、现网流量压测/" itemprop="url">利用tcpburn进行长连接压测、现网流量压测</a></h2>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2019-03-22T11:39:01+08:00">
                2019-03-22
              </time>
            

            

            
          </span>

          
            <span class="post-category">
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/后台技术/" itemprop="url" rel="index">
                    <span itemprop="name">后台技术</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h2 id="利用tcpburn进行长连接压测、现网流量压测"><a href="#利用tcpburn进行长连接压测、现网流量压测" class="headerlink" title="利用tcpburn进行长连接压测、现网流量压测"></a>利用tcpburn进行长连接压测、现网流量压测</h2><ol start="0">
<li>安装tcpcopy(主要是使用其intercept)或者是intercept    </li>
<li><p>配置<br>配置是成功的关键，<code>注意所有用来部署intercept、tcpburn、目标服务都必须在同一个网段</code>。<br>0)目标服务：待测试的服务部署 这里假定端口是16001  ip：a.b.c.234<br>   添加路由规则主要是将待测试服务的应答包正确的路由到intercept服务，由intercept服务转发到tcpburn，完整整个过程。  </p>
   <figure class="highlight plain"><figcaption><span>add -net 62.135.0.0 netmask 255.255.0.0 gw a.b.c.123  ```  </span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">      注意这里的net 62.135.0.0 需要与intercept -F中配置的项对应（如果要配置的话）。  </span><br><span class="line">      gw 这里填的是intercept 的ip。  </span><br><span class="line">      如果想要删除路由规则用下面的将上面的add 换成del 即可其他的不变  </span><br><span class="line">```route del -net 62.135.0.0 netmask 255.255.0.0 gw a.b.c.123  ```  </span><br><span class="line">   1)首先我们需要一台server a.b.c.123来部署intercept，启动端口默认是36524启动命令比简单：  </span><br><span class="line">      ```intercept -i eth1 -F &quot;src port 16001 and net 62.135.250.0/24&quot; -d```  </span><br><span class="line">      注意这里的-F 中的条件是用来过滤目标服务器回报那些需要转发给tcpburn。   </span><br><span class="line">      比如目标服务器待测试的端口是`16001`，那么`src port 16001 `就是从源端口是16001发出的数据包。    </span><br><span class="line">      net 表示网段是`62.135.250.0/24`的，这里需要跟tcpburn中`-c`参数中指定的相匹配。     </span><br><span class="line">   2)部署tcpburn：可以跟intercept部署在一台server上：a.b.c.123   </span><br><span class="line">     启动命令：  </span><br><span class="line">    ```./tcpburn -x 16001-a.b.c.234:16001 -f 16001_online_test.cap -s a.b.c.123 -p 36524 -u 100 -c 62.135.250.x ```   </span><br><span class="line">     `注意需要优先启动intercept，否则会链接失败`    </span><br><span class="line">     这里需要注意的几个地方：   </span><br><span class="line">        16001-a.b.c.234:16001   前面的16001是生成16001_online_test.cap 抓包使用的端口后面的ip端口是目标测试服务的ip和端口。  </span><br><span class="line">        -s 指定intercept 的ip   </span><br><span class="line">        -p指定intercept的端口   </span><br><span class="line">        -u是模拟多少客户端 </span><br><span class="line">        -c是客户端的网段，这里的网段必须与intercept中过滤条件、目标服务器上添加的net相对应。</span><br><span class="line">    由于tcpburn是基于流量回放的模式所以需要事前抓一个数据包 16001_online_test.cap是通过tcpdump抓包的数据，用来发送到目标测试服务的。    </span><br><span class="line">       ```tcpdump -s 0 port 16001 -i any -w 16001_online_test.cap -c 20000  ```  </span><br><span class="line">    ``` shell</span><br><span class="line">   ./tcpburn -x historyServerPort-targetServerIP:targetServerPort -f &lt;pcapfile,&gt; -s &lt;intercept address&gt; -u &lt;user num&gt; -c &lt;ip range,&gt;</span><br></pre></td></tr></table></figure>
<p>如果是想测试支持长连接的，那么编译tcpburn时configure带上参数<code>--comet</code>,再也不用担心编写接入层服务时200万长连接由于机器限制端口范围（1024-65535）而各种nat、虚拟网卡、虚拟ip、服务启动多个端口、客户端起多个进程等等这些繁琐的事情了</p>
<h2 id="附录："><a href="#附录：" class="headerlink" title="附录："></a>附录：</h2><h3 id="安装方法："><a href="#安装方法：" class="headerlink" title="安装方法："></a>安装方法：</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">sudo apt-get install libpcap libpcap-devel</span><br><span class="line"></span><br><span class="line">cd `pwd`/tcpcopy-0.9.9</span><br><span class="line">make clean</span><br><span class="line">sh autogen.sh</span><br><span class="line">./configure --enable-single --enable-pcap --enable-advanced</span><br><span class="line">make </span><br><span class="line">make install</span><br><span class="line"></span><br><span class="line">cd `pwd`/tcpburn</span><br><span class="line">make clean</span><br><span class="line"><span class="meta">#</span><span class="bash">./configure --single    <span class="comment">#支持--single模式</span></span></span><br><span class="line">./configure --single  --comet  #支持comet 模式即长连接模式</span><br><span class="line">make</span><br><span class="line">make install</span><br></pre></td></tr></table></figure>
</li>
</ol>
<h3 id="简单的自动配置脚本生成工具"><a href="#简单的自动配置脚本生成工具" class="headerlink" title="简单的自动配置脚本生成工具"></a>简单的自动配置脚本生成工具</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash">intercept server</span></span><br><span class="line">intercept_server=a.b.c.123</span><br><span class="line">intercept_port=36524</span><br><span class="line"><span class="meta">#</span><span class="bash">our <span class="built_in">test</span> service</span></span><br><span class="line">target_server=a.b.c.234</span><br><span class="line">target_port=16001</span><br><span class="line">tcpdump_port=16001</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash">generate by tcpdump -s 0 port 80(your port) -i any -w 80.cap</span></span><br><span class="line">cap_file=$tcpdump_port.cap</span><br><span class="line">client_net_range=62.135.250.x</span><br><span class="line">route_net=`echo $client_net_range|awk -F'.' '&#123;print $1"."$2".0.0"&#125;'`</span><br><span class="line">intercept_filter_net=`echo $client_net_range|awk -F'.' '&#123;print $1"."$2"."$3".0"&#125;'`</span><br><span class="line"></span><br><span class="line">echo "###################################################################################"</span><br><span class="line">echo "#intercept install on $intercept_server"</span><br><span class="line">echo "#target_server  install on $intercept_server ,such as(client_access\setlogic)"</span><br><span class="line">echo "#run this command on $target_server"</span><br><span class="line">echo "# route add -net $route_net netmask 255.255.0.0 gw $intercept_server"</span><br><span class="line">echo "# for delete runing:"</span><br><span class="line">echo "# route del -net $route_net netmask 255.255.0.0 gw $intercept_server"</span><br><span class="line">echo "#use tcpdump to capture packet on realserver,eg:"</span><br><span class="line">echo "#    tcpdump -s 0 port $tcpdump_port -i any -w $cap_file"</span><br><span class="line">echo "#"</span><br><span class="line">echo "# use this command to run tcpburn:"</span><br><span class="line">echo "#./tcpburn/objs/tcpburn -x $tcpdump_port-$target_server:$target_port -f $cap_file -s $intercept_server -p $intercept_port -u 100 -c $client_net_range"</span><br><span class="line">echo "###################################################################################"</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash">1. <span class="built_in">set</span> route on target server</span></span><br><span class="line"><span class="meta">#</span><span class="bash">eg:</span></span><br><span class="line"><span class="meta">#</span><span class="bash">Assume 65.135.233.161 is the IP address of the assistant server. We <span class="built_in">set</span> the following</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> route commands to route all responses to the 62.135.200.x<span class="string">'s clients to the assistant</span></span></span><br><span class="line"><span class="meta">#</span><span class="bash"> server.</span></span><br><span class="line"><span class="meta">#</span><span class="bash">add:</span></span><br><span class="line"><span class="meta">#</span><span class="bash">  route add -net 62.135.200.0 netmask 255.255.255.0 gw 65.135.233.161</span></span><br><span class="line"><span class="meta">#</span><span class="bash">delete:</span></span><br><span class="line"><span class="meta">#</span><span class="bash">  route  -net 62.135.200.0 netmask 255.255.255.0 gw 65.135.233.161</span></span><br><span class="line"><span class="meta">#</span><span class="bash">run this on targe sever:such as on  execute:</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> net 62.135.0.0 must match the client ips at tcpburn option -c here is <span class="string">"62.135.250.x"</span></span></span><br><span class="line"><span class="meta">#</span><span class="bash">       route add -net `<span class="built_in">echo</span> <span class="variable">$client_net_range</span>|awk -F<span class="string">'.'</span> <span class="string">'&#123;print $1"."$2".0.0"&#125;'</span> netmask 255.255.0.0 gw <span class="variable">$intercept_server</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash">2.start intercept </span></span><br><span class="line"><span class="meta">#</span><span class="bash"><span class="string">"src port 80"</span> is match with tcpdump capture</span></span><br><span class="line"><span class="meta">#</span><span class="bash">eg:</span></span><br><span class="line">echo intercept -i eth1 -F \"src port $target_port and net $intercept_filter_net/24\"  -d</span><br><span class="line">intercept -i eth1 -F "src port $target_port and net $intercept_filter_net/24"  -d</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash">3. start tcpburn to send request to target server throught intercept</span></span><br><span class="line"><span class="meta">#</span><span class="bash">eg:</span></span><br><span class="line"><span class="meta">#</span><span class="bash">Assume 65.135.233.160 is the IP address of the target server and 10.110.10.161 is the</span></span><br><span class="line"><span class="meta">#</span><span class="bash">internal IP address of the assistant server and 65.135.233.161 is the external IP </span></span><br><span class="line"><span class="meta">#</span><span class="bash">address of the assistant server.</span></span><br><span class="line"><span class="meta">#</span><span class="bash">  ./tcpburn -x 80-65.135.233.160:80 -f /path/to/80.pcap -s 10.110.10.161 </span></span><br><span class="line"><span class="meta">#</span><span class="bash">   -u 10000 -c 62.135.200.x</span></span><br><span class="line">sleep 5</span><br><span class="line">netstat -anp|grep $intercept_port</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash">file <span class="variable">$cap_file</span> is tcpdump: tcpdump -s 0 dst port <span class="variable">$tcpdump_port</span> -i any -c 1000000 -w <span class="variable">$cap_file</span></span></span><br><span class="line">echo ./tcpburn/objs/tcpburn -x $tcpdump_port-$target_server:$target_port -f $cap_file -s $intercept_server -p $intercept_port -u 100 -c $client_net_range</span><br><span class="line">echo "tcpburn log on /usr/local/tcpburn/logs"</span><br></pre></td></tr></table></figure>
<p><a href="https://github.com/leeqx/tcpburn" target="_blank" rel="noopener">tcpburn</a><br><a href="http://blog.upcoder.net/?p=84" target="_blank" rel="noopener">tcpburn案例</a>  </p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://leeqx.github.io/2019/03/22/基于linux-汇编深入理解c程序/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Qinglin Li">
      <meta itemprop="description" content>
      <meta itemprop="image" content="https://avatars1.githubusercontent.com/u/931925?s=460&v=4">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="linux programer">
    </span>

    
      <header class="post-header">

        
        
          <h2 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2019/03/22/基于linux-汇编深入理解c程序/" itemprop="url">基于linux-汇编深入理解c程序</a></h2>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2019-03-22T11:39:01+08:00">
                2019-03-22
              </time>
            

            

            
          </span>

          
            <span class="post-category">
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/后台技术/" itemprop="url" rel="index">
                    <span itemprop="name">后台技术</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h2 id="一个简单的入门实例"><a href="#一个简单的入门实例" class="headerlink" title="一个简单的入门实例"></a>一个简单的入门实例</h2><p>  实现一个简单的exit(0);<br>  exit.s<br>  <figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line">  # 数据段的开始</span><br><span class="line">  .section .data</span><br><span class="line">  # 代码段开始（存放程序指令的部分）</span><br><span class="line">  .section .text</span><br><span class="line">  #注意这里的.globl 表示汇编程序不应在汇编之后废弃次符号（_start) ,因为连接  </span><br><span class="line">  # 器需要它。_start 是个特殊的符号，总是用.global 来标记，因为它标记了该程序的开始位置。</span><br><span class="line">  .globl _start</span><br><span class="line">  #定义_start 标签（符号)的值，该标签后面的：告诉汇编程序，以该符号的只作为下一条指令或者下一个数据元素的位置</span><br><span class="line">  _start:</span><br><span class="line">     # 用于退出linux 内核命令号（系统调用)</span><br><span class="line">     movl $1,%eax</span><br><span class="line">     # 将0 作为退出码,echo $? 可以看到该值</span><br><span class="line">     movl $0,%ebx</span><br><span class="line">     #调用系统0x80号中断（唤醒内核运行退出命令)</span><br><span class="line">     int $0x80  </span><br><span class="line">   ``` </span><br><span class="line">  编译运行方法：  </span><br><span class="line">  ```sh</span><br><span class="line">   as exit.s -o exit.o</span><br><span class="line">   ld exit.o -o exit</span><br><span class="line">  ``` </span><br><span class="line">## 寄存器  </span><br><span class="line">  通用寄存器：</span><br><span class="line">  ```asm</span><br><span class="line">  %eax</span><br><span class="line">  %ebx</span><br><span class="line">  %ecx</span><br><span class="line">  %edx</span><br><span class="line">  %edi</span><br><span class="line">  %esi</span><br></pre></td></tr></table></figure></p>
<p>专用寄存器：<br>  <figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">  %ebp（栈基址)</span><br><span class="line">  %esp(栈顶）</span><br><span class="line">  %eip（指令寄存器)</span><br><span class="line">  %eflags</span><br><span class="line">``` </span><br><span class="line">## 寻址方式  </span><br><span class="line">  内存地址引用的通用格式如下：</span><br><span class="line">  ```asm</span><br><span class="line">  地址或者偏移(%基址寄存器,%索引寄存器,比例因子)</span><br></pre></td></tr></table></figure></p>
<p>  所有字段都是可选的，要计算地址可以按照下面公式进行计算：<br>  结果地址 = 地址或者偏移 + %基址或者偏移量寄存器 + 比例因子 * %索引寄存器<br>  其中地址或者偏移量 以及比例因子都必须是常量，其余的两个必须是寄存器。如果要省略任何一项，那么等式可以将0代替该项。 </p>
<ol start="0">
<li><p>直接寻址方式<br> 此模式可以通过使用<code>地址或者偏移</code>部分实现：（即上面公式中%基址或者偏移量寄存器 和 %索引寄存器都是0）   </p>
 <figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">movl ADDRESS, %eax</span><br></pre></td></tr></table></figure>
<p> 以上指定将内存地址ADDRESS 加载到%eax  </p>
</li>
<li><p>索引寻址方式<br> 这种模式将通过使用·地址<code>者偏移量以及%索引寄存器</code>部分实现（%索引寄存器可以是任何通用寄存器）。  </p>
 <figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">    movl string_start(,%ecx,1), %eax  </span><br><span class="line">    ```  </span><br><span class="line">    该指令从string_start 处开始，将改地址与1*%ecx 相加，并将所得值加载到 %eax   </span><br><span class="line"></span><br><span class="line">0. 间接寻址方式  </span><br><span class="line">    间接寻址方式从寄存器从寄存器指定的地址加载值例如：如果%eax 保存着一个地址，我们可以通通过下面的方式将该地址中的值移入到%ebx</span><br><span class="line">    ```asm</span><br><span class="line">     movl (%eax), %ebx</span><br></pre></td></tr></table></figure>
</li>
<li><p>基址寻址方式<br> 基址寻址方式与间接寻址方式类似，不同之处在于它将一个常量值与寄存器中的地址相加。例如：<br> 如果已有一个记录，其中年龄值位于记录起始地址后4个字节处，该记录的起始地址在%eax中，那么<br> 下面的指令将年龄提取到%ebx中：</p>
 <figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">movl 4(%eax), %ebx</span><br></pre></td></tr></table></figure>
</li>
<li><p>立即寻址方式<br> 用于直接将值加载到寄存器或者存储位置.数字前面加$表示是立即数，否则表示的是将位于存储位置12中的值而不是12 加载到%eax   </p>
 <figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">movl $12, %eax</span><br></pre></td></tr></table></figure>
</li>
<li><p>寄存器寻址方式<br> 寄存器寻址方式仅仅是将数据移入或者移出寄存器</p>
</li>
</ol>
<p><code>注意：除了立即寻址方式外的其他寻址方式都可用作源或者目的操作数。而立即寻址方式只能是源操作数</code><br><code>不同的指令操作的数据字节数不同例如movl 移动一个字，movb 移动一个字节大小</code></p>
<p>下面是%eax寄存器的布局：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">|&lt;--------%eax--------&gt;|</span><br><span class="line">[    ][    ][ %ah][%al ]</span><br><span class="line">            |&lt;--%ax---&gt;|</span><br></pre></td></tr></table></figure></p>
<ol start="0">
<li><p>实例二<br> 查找最大值</p>
 <figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line">.section .data</span><br><span class="line"> data_items:   #数据项存放在数据段</span><br><span class="line">   .long </span><br><span class="line">   </span><br><span class="line">.section .text</span><br><span class="line"></span><br><span class="line">.globl _start</span><br><span class="line">_start:</span><br><span class="line">  movl $0,%edi  $0移入索引寄存器</span><br><span class="line">  movl data_items(,%edi,4), %eax#加载第一个元素到%eax</span><br><span class="line">  movl %eax ,%ebx    #%ebx 存放最大值，由于是第一项所以就是最大值</span><br><span class="line"></span><br><span class="line">start_loop:</span><br><span class="line">  cmpl $0,$eax        #数据中0 作为数据结束的标志</span><br><span class="line">  je loop_exit</span><br><span class="line">  incl %edi           #索引指向下一个元素</span><br><span class="line">  movl data_items(,%edi,4) ,%eax</span><br><span class="line">  cmp %ebx,%eax       #比较当前元素于原有的最大值</span><br><span class="line">  jle start_loop</span><br><span class="line"></span><br><span class="line">  movl %eax,%ebx       #将新的最大值移入%ebx</span><br><span class="line">  jmp  start_loop</span><br><span class="line"></span><br><span class="line">loop_exit:</span><br><span class="line">   movl $1 ,%eax      #1 是exit()系统调用</span><br><span class="line">   int $0x80</span><br></pre></td></tr></table></figure>
<p> 汇编连接：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">    as maximum.s -o maximum.o</span><br><span class="line">    ld maximum.o -o maximum</span><br><span class="line">    ./maximum </span><br><span class="line">     $echo $?     #注意这里会打印最大值，因为我们程序计算结果就是保存在%ebx中</span><br><span class="line">    ```   </span><br><span class="line"></span><br><span class="line">***</span><br><span class="line">## 关于函数  </span><br><span class="line">  一个函数一般由一下几个部分：`函数名、函数参数、局部变量、静态变量、全局变量、返回地址、返回值`  </span><br><span class="line">  约定函数参数从又到左入栈。</span><br><span class="line"></span><br><span class="line">  ```asm</span><br><span class="line">    参数 #N  &lt;----- N*4 + 4(%ebp)    [高地址]</span><br><span class="line">    ...                       </span><br><span class="line">    参数 2   &lt;----- 12(%ebp)</span><br><span class="line">    参数 1   &lt;----- 8(%ebp)</span><br><span class="line">    返回地址  &lt;----- 4(%ebp)</span><br><span class="line">    旧%ebp   &lt;----- (%esp) 和 （%ebp) [低地址]</span><br><span class="line">    局部变量 1 &lt;---- -4(%ebp)</span><br><span class="line">    局部变量 2 &lt;---- -8(%ebp) 和 （%esp)</span><br></pre></td></tr></table></figure>
<p>从上面可以看出 通过%ebp寄存器可以获取到参数、局部变量<br>如果需要从函数返回，那么需要执行一下指令   </p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">movl %ebp,%esp</span><br><span class="line">popl %ebp</span><br><span class="line">ret</span><br></pre></td></tr></table></figure>
</li>
</ol>
<ul>
<li><p>函数示例<br>计算2^3 + 5^2  </p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br></pre></td><td class="code"><pre><span class="line"> #主程序中的所有内容都存储在寄存器中，</span><br><span class="line"> #因此数据段不含任何内容</span><br><span class="line"> .section .data</span><br><span class="line"> .section .text</span><br><span class="line"> .globl _start</span><br><span class="line"></span><br><span class="line"> _start:</span><br><span class="line">   pushl $3</span><br><span class="line">   pushl $2</span><br><span class="line">   call power</span><br><span class="line">   addl $8, %esp</span><br><span class="line">   pushl %eax</span><br><span class="line">  </span><br><span class="line">   pushl $2</span><br><span class="line">   pushl $5</span><br><span class="line">   call power</span><br><span class="line">   addl $8, %esp</span><br><span class="line">   </span><br><span class="line">   popl %ebx</span><br><span class="line">  </span><br><span class="line">   addl %eax, %ebx</span><br><span class="line">  </span><br><span class="line">   movl $1, %eax</span><br><span class="line">   int $0x80</span><br><span class="line">.type power,@function   #告诉连接器 factorial 是个函数，处罚法我们需要在别的程序中使用factorial函数，否则这条指令不是必须的。</span><br><span class="line">power:</span><br><span class="line">  pushl %ebp</span><br><span class="line">  movl  %esp,%ebp</span><br><span class="line">  subl  $4,%esp</span><br><span class="line">  movl 8(%ebp),%ebx</span><br><span class="line">  movl 12(%ebp),%ecx</span><br><span class="line"></span><br><span class="line">  movl %ebx, -4(%ebp)</span><br><span class="line">power_loop_start:</span><br><span class="line">  cmpl $1,%ecx</span><br><span class="line">  je end_power</span><br><span class="line">  movl -4(%ebp),%eax</span><br><span class="line">  imull %ebx,%eax</span><br><span class="line">  movl %eax, -4(%ebp)</span><br><span class="line"></span><br><span class="line">  decl %ecx</span><br><span class="line">  jmp power_loop_start</span><br><span class="line"></span><br><span class="line"> end_power:</span><br><span class="line">   movl -4(%ebp),%eax</span><br><span class="line">   movl %ebp,%esp</span><br><span class="line">   popl %ebp</span><br><span class="line">   ret</span><br></pre></td></tr></table></figure>
</li>
<li><p>递归调用函数  </p>
  <figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line">.section .data</span><br><span class="line">#本程序无全局数据</span><br><span class="line">.section .text</span><br><span class="line"> </span><br><span class="line">.globl _start</span><br><span class="line">.globl factorial #除非我们希望与其他程序共享该函数，否则无需此项</span><br><span class="line">_start:</span><br><span class="line">  pushl $4</span><br><span class="line">  call factorial</span><br><span class="line">  addl $4,%esp</span><br><span class="line">  movl %eax,%ebx</span><br><span class="line"></span><br><span class="line">  movl $1, %eax</span><br><span class="line">  int $0x80</span><br><span class="line">   </span><br><span class="line">  # 这是实际函数的含义</span><br><span class="line">  .type factorial,@function</span><br><span class="line">  factorial:</span><br><span class="line">    pushl %ebp</span><br><span class="line">    movl  %esp,%ebp</span><br><span class="line">    movl 8(%ebp),%eax</span><br><span class="line">    cmpl $1, %eax</span><br><span class="line">    je end_factorial</span><br><span class="line">    decl %eax          #否则就递减</span><br><span class="line">    pushl %eax</span><br><span class="line">    call factorial</span><br><span class="line">    movl 8(%ebp),%ebx</span><br><span class="line"></span><br><span class="line">    imull %ebx,%eax</span><br><span class="line">   </span><br><span class="line">  end_factorial:</span><br><span class="line">    movl %ebp, %esp</span><br><span class="line">    popl %ebp</span><br><span class="line">    ret</span><br></pre></td></tr></table></figure></li>
</ul>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
  </section>

  
  <nav class="pagination">
    <a class="extend prev" rel="prev" href="/"><i class="fa fa-angle-left"></i></a><a class="page-number" href="/">1</a><span class="page-number current">2</span><a class="page-number" href="/page/3/">3</a><a class="page-number" href="/page/4/">4</a><a class="extend next" rel="next" href="/page/3/"><i class="fa fa-angle-right"></i></a>
  </nav>



          </div>
          


          

        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    
    <div class="sidebar-inner">

      

      

      <section class="site-overview-wrap sidebar-panel sidebar-panel-active">
        <div class="site-overview">
          <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
            
              <img class="site-author-image" itemprop="image" src="https://avatars1.githubusercontent.com/u/931925?s=460&v=4" alt="Qinglin Li">
            
              <p class="site-author-name" itemprop="name">Qinglin Li</p>
              <p class="site-description motion-element" itemprop="description"></p>
          </div>

          <nav class="site-state motion-element">

            
              <div class="site-state-item site-state-posts">
              
                <a href="/archives/">
              
                  <span class="site-state-item-count">32</span>
                  <span class="site-state-item-name">日志</span>
                </a>
              </div>
            

            
              
              
              <div class="site-state-item site-state-categories">
                <a href="/categories/index.html">
                  <span class="site-state-item-count">2</span>
                  <span class="site-state-item-name">分类</span>
                </a>
              </div>
            

            
              
              
              <div class="site-state-item site-state-tags">
                <a href="/tags/index.html">
                  <span class="site-state-item-count">5</span>
                  <span class="site-state-item-name">标签</span>
                </a>
              </div>
            

          </nav>

          

          
            <div class="links-of-author motion-element">
                
                  <span class="links-of-author-item">
                    <a href="https://github.com/leeqx" target="_blank" title="GitHub">
                      
                        <i class="fa fa-fw fa-github"></i>GitHub</a>
                  </span>
                
            </div>
          

          
          

          
          

          

        </div>
      </section>

      

      

    </div>
  </aside>


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright">&copy; 2015 &mdash; <span itemprop="copyrightYear">2019</span>
  <span class="with-love">
    <i class="fa fa-user"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">QingxinLi@2015</span>

  
</div>






  <div class="theme-info">主题 &mdash; <a class="theme-link" target="_blank" href="https://github.com/iissnan/hexo-theme-next">NexT.Muse</a> v5.1.4</div>




        







        
      </div>
    </footer>

    
      <div class="back-to-top">
        <i class="fa fa-arrow-up"></i>
        
      </div>
    

    

  </div>

  

<script type="text/javascript">
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>









  












  
  
    <script type="text/javascript" src="/lib/jquery/index.js?v=2.1.3"></script>
  

  
  
    <script type="text/javascript" src="/lib/fastclick/lib/fastclick.min.js?v=1.0.6"></script>
  

  
  
    <script type="text/javascript" src="/lib/jquery_lazyload/jquery.lazyload.js?v=1.9.7"></script>
  

  
  
    <script type="text/javascript" src="/lib/velocity/velocity.min.js?v=1.2.1"></script>
  

  
  
    <script type="text/javascript" src="/lib/velocity/velocity.ui.min.js?v=1.2.1"></script>
  

  
  
    <script type="text/javascript" src="/lib/fancybox/source/jquery.fancybox.pack.js?v=2.1.5"></script>
  


  


  <script type="text/javascript" src="/js/src/utils.js?v=5.1.4"></script>

  <script type="text/javascript" src="/js/src/motion.js?v=5.1.4"></script>



  
  

  

  


  <script type="text/javascript" src="/js/src/bootstrap.js?v=5.1.4"></script>



  


  




	





  





  







<!-- LOCAL: You can save these files to your site and update links -->
    
        
        <link rel="stylesheet" href="https://aimingoo.github.io/gitmint/style/default.css">
        <script src="https://aimingoo.github.io/gitmint/dist/gitmint.browser.js"></script>
    
<!-- END LOCAL -->

    

    







  





  

  

  
<script>
(function(){
    var bp = document.createElement('script');
    var curProtocol = window.location.protocol.split(':')[0];
    if (curProtocol === 'https') {
        bp.src = 'https://zz.bdstatic.com/linksubmit/push.js';        
    }
    else {
        bp.src = 'http://push.zhanzhang.baidu.com/push.js';
    }
    var s = document.getElementsByTagName("script")[0];
    s.parentNode.insertBefore(bp, s);
})();
</script>


  
  

  

  

  

</body>
</html>

<!DOCTYPE html>



  


<html class="theme-next muse use-motion" lang="zh-Hans">
<head><meta name="generator" content="Hexo 3.8.0">
  <meta charset="UTF-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
<meta name="theme-color" content="#222">









<meta http-equiv="Cache-Control" content="no-transform">
<meta http-equiv="Cache-Control" content="no-siteapp">
















  
  
  <link href="/lib/fancybox/source/jquery.fancybox.css?v=2.1.5" rel="stylesheet" type="text/css">







<link href="/lib/font-awesome/css/font-awesome.min.css?v=4.6.2" rel="stylesheet" type="text/css">

<link href="/css/main.css?v=5.1.4" rel="stylesheet" type="text/css">


  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png?v=5.1.4">


  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png?v=5.1.4">


  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png?v=5.1.4">


  <link rel="mask-icon" href="/images/logo.svg?v=5.1.4" color="#222">





  <meta name="keywords" content="糊涂之至，方能致远!!">










<meta name="keywords" content="Linux Programs">
<meta property="og:type" content="website">
<meta property="og:title" content="linux programer">
<meta property="og:url" content="http://leeqx.github.io/page/2/index.html">
<meta property="og:site_name" content="linux programer">
<meta property="og:locale" content="zh-Hans">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="linux programer">



<script type="text/javascript" id="hexo.configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    root: '/',
    scheme: 'Muse',
    version: '5.1.4',
    sidebar: {"position":"left","display":"post","offset":12,"b2t":false,"scrollpercent":false,"onmobile":false},
    fancybox: true,
    tabs: true,
    motion: {"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},
    duoshuo: {
      userId: '0',
      author: '博主'
    },
    algolia: {
      applicationID: '',
      apiKey: '',
      indexName: '',
      hits: {"per_page":10},
      labels: {"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}
    }
  };
</script>



  <link rel="canonical" href="http://leeqx.github.io/page/2/">





  <title>linux programer</title>
  





  <script type="text/javascript">
    var _hmt = _hmt || [];
    (function() {
      var hm = document.createElement("script");
      hm.src = "https://hm.baidu.com/hm.js?true";
      var s = document.getElementsByTagName("script")[0];
      s.parentNode.insertBefore(hm, s);
    })();
  </script>




</head>

<body itemscope itemtype="http://schema.org/WebPage" lang="zh-Hans">

  
  
    
  

  <div class="container sidebar-position-left 
  page-home">
    <div class="headband"></div>

    <header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-wrapper">
  <div class="site-meta ">
    

    <div class="custom-logo-site-title">
      <a href="/" class="brand" rel="start">
        <span class="logo-line-before"><i></i></span>
        <span class="site-title">linux programer</span>
        <span class="logo-line-after"><i></i></span>
      </a>
    </div>
      
        <h1 class="site-subtitle" itemprop="description">不吝赐教</h1>
      
  </div>

  <div class="site-nav-toggle">
    <button>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
    </button>
  </div>
</div>

<nav class="site-nav">
  

  
    <ul id="menu" class="menu">
      
        
        <li class="menu-item menu-item-home">
          <a href="/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-home"></i> <br>
            
            首页
          </a>
        </li>
      
        
        <li class="menu-item menu-item-about">
          <a href="/about/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-user"></i> <br>
            
            关于
          </a>
        </li>
      
        
        <li class="menu-item menu-item-tags">
          <a href="/tags/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-tags"></i> <br>
            
            标签
          </a>
        </li>
      
        
        <li class="menu-item menu-item-categories">
          <a href="/categories/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-th"></i> <br>
            
            分类
          </a>
        </li>
      
        
        <li class="menu-item menu-item-archives">
          <a href="/archives/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-archive"></i> <br>
            
            归档
          </a>
        </li>
      
        
        <li class="menu-item menu-item-schedule">
          <a href="/schedule/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-calendar"></i> <br>
            
            日程表
          </a>
        </li>
      
        
        <li class="menu-item menu-item-sitemap">
          <a href="/sitemap.xml" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-sitemap"></i> <br>
            
            站点地图
          </a>
        </li>
      

      
    </ul>
  

  
</nav>



 </div>
    </header>

    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          <div id="content" class="content">
            
  <section id="posts" class="posts-expand">
    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://leeqx.github.io/2019/03/22/Redis-网络事件/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Qinglin Li">
      <meta itemprop="description" content>
      <meta itemprop="image" content="https://avatars1.githubusercontent.com/u/931925?s=460&v=4">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="linux programer">
    </span>

    
      <header class="post-header">

        
        
          <h2 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2019/03/22/Redis-网络事件/" itemprop="url">未命名</a></h2>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2019-03-22T10:37:35+08:00">
                2019-03-22
              </time>
            

            

            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h2 id="Redis-网络模型"><a href="#Redis-网络模型" class="headerlink" title="Redis 网络模型"></a>Redis 网络模型</h2><p>  redis 在main方法中调用了initServer 方法,在该方法中调用了aeCreateFileEvent方法来绑定文件socket的回调方法。<br>  下面将acceptTcpHandler绑定到监听的socket：  </p>
  <figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">  <span class="keyword">for</span> (j = <span class="number">0</span>; j &lt; server.ipfd_count; j++) &#123;</span><br><span class="line">    <span class="keyword">if</span> (aeCreateFileEvent(server.el, server.ipfd[j], AE_READABLE,</span><br><span class="line">        acceptTcpHandler,<span class="literal">NULL</span>) == AE_ERR)</span><br><span class="line">        &#123;</span><br><span class="line">            redisPanic(</span><br><span class="line">                <span class="string">"Unrecoverable error creating server.ipfd file event."</span>);</span><br><span class="line">        &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>然后在main中调用aeMain 方法循环处理网络事件。在aeMain中调用了aeProcessEvents来真正处理网络事件。以下是redis的网络核心代码：  </p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">aeProcessEvents</span><span class="params">(aeEventLoop *eventLoop, <span class="keyword">int</span> flags)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">int</span> processed = <span class="number">0</span>, numevents;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* Nothing to do? return ASAP */</span></span><br><span class="line">    <span class="keyword">if</span> (!(flags &amp; AE_TIME_EVENTS) &amp;&amp; !(flags &amp; AE_FILE_EVENTS)) <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* Note that we want call select() even if there are no</span></span><br><span class="line"><span class="comment">     * file events to process as long as we want to process time</span></span><br><span class="line"><span class="comment">     * events, in order to sleep until the next time event is ready</span></span><br><span class="line"><span class="comment">     * to fire. */</span></span><br><span class="line">    <span class="keyword">if</span> (eventLoop-&gt;maxfd != <span class="number">-1</span> ||</span><br><span class="line">        ((flags &amp; AE_TIME_EVENTS) &amp;&amp; !(flags &amp; AE_DONT_WAIT))) &#123;</span><br><span class="line">        <span class="keyword">int</span> j;</span><br><span class="line">        aeTimeEvent *shortest = <span class="literal">NULL</span>;</span><br><span class="line">        <span class="class"><span class="keyword">struct</span> <span class="title">timeval</span> <span class="title">tv</span>, *<span class="title">tvp</span>;</span></span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (flags &amp; AE_TIME_EVENTS &amp;&amp; !(flags &amp; AE_DONT_WAIT))</span><br><span class="line">            shortest = aeSearchNearestTimer(eventLoop);</span><br><span class="line">        <span class="keyword">if</span> (shortest) &#123;</span><br><span class="line">            <span class="keyword">long</span> now_sec, now_ms;</span><br><span class="line"></span><br><span class="line">            <span class="comment">/* Calculate the time missing for the nearest</span></span><br><span class="line"><span class="comment">             * timer to fire. */</span></span><br><span class="line">            aeGetTime(&amp;now_sec, &amp;now_ms);</span><br><span class="line">            tvp = &amp;tv;</span><br><span class="line">            tvp-&gt;tv_sec = shortest-&gt;when_sec - now_sec;</span><br><span class="line">            <span class="keyword">if</span> (shortest-&gt;when_ms &lt; now_ms) &#123;</span><br><span class="line">                tvp-&gt;tv_usec = ((shortest-&gt;when_ms+<span class="number">1000</span>) - now_ms)*<span class="number">1000</span>;</span><br><span class="line">                tvp-&gt;tv_sec --;</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                tvp-&gt;tv_usec = (shortest-&gt;when_ms - now_ms)*<span class="number">1000</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">if</span> (tvp-&gt;tv_sec &lt; <span class="number">0</span>) tvp-&gt;tv_sec = <span class="number">0</span>;</span><br><span class="line">            <span class="keyword">if</span> (tvp-&gt;tv_usec &lt; <span class="number">0</span>) tvp-&gt;tv_usec = <span class="number">0</span>;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="comment">/* If we have to check for events but need to return</span></span><br><span class="line"><span class="comment">             * ASAP because of AE_DONT_WAIT we need to set the timeout</span></span><br><span class="line"><span class="comment">             * to zero */</span></span><br><span class="line">            <span class="keyword">if</span> (flags &amp; AE_DONT_WAIT) &#123;</span><br><span class="line">                tv.tv_sec = tv.tv_usec = <span class="number">0</span>;</span><br><span class="line">                tvp = &amp;tv;</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                <span class="comment">/* Otherwise we can block */</span></span><br><span class="line">                tvp = <span class="literal">NULL</span>; <span class="comment">/* wait forever */</span></span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        numevents = aeApiPoll(eventLoop, tvp);</span><br><span class="line">        <span class="keyword">for</span> (j = <span class="number">0</span>; j &lt; numevents; j++) &#123;</span><br><span class="line">            aeFileEvent *fe = &amp;eventLoop-&gt;events[eventLoop-&gt;fired[j].fd];</span><br><span class="line">            <span class="keyword">int</span> mask = eventLoop-&gt;fired[j].mask;</span><br><span class="line">            <span class="keyword">int</span> fd = eventLoop-&gt;fired[j].fd;</span><br><span class="line">            <span class="keyword">int</span> rfired = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">	    <span class="comment">/* note the fe-&gt;mask &amp; mask &amp; ... code: maybe an already processed</span></span><br><span class="line"><span class="comment">             * event removed an element that fired and we still didn't</span></span><br><span class="line"><span class="comment">             * processed, so we check if the event is still valid. */</span></span><br><span class="line">            <span class="keyword">if</span> (fe-&gt;mask &amp; mask &amp; AE_READABLE) &#123;</span><br><span class="line">                rfired = <span class="number">1</span>;</span><br><span class="line">                fe-&gt;rfileProc(eventLoop,fd,fe-&gt;clientData,mask);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">if</span> (fe-&gt;mask &amp; mask &amp; AE_WRITABLE) &#123;</span><br><span class="line">                <span class="keyword">if</span> (!rfired || fe-&gt;wfileProc != fe-&gt;rfileProc)</span><br><span class="line">                    fe-&gt;wfileProc(eventLoop,fd,fe-&gt;clientData,mask);</span><br><span class="line">            &#125;</span><br><span class="line">            processed++;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">/* Check time events */</span></span><br><span class="line">    <span class="keyword">if</span> (flags &amp; AE_TIME_EVENTS)</span><br><span class="line">        processed += processTimeEvents(eventLoop);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> processed; <span class="comment">/* return the number of processed file/time events */</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>在上面的方法中可以看到有定时器时间处理，同时也看到了在调用对应的rfileProc 函数指针，对于监听的socket其对应的是：acceptTcpHandler；对于客户端socket其对应的是：readQueryFromClient。具体在哪里设置readQueryFromClient，在后面的章节中会讲到。<br>在acceptTcpHandler方法中会与客户端建立连接：</p>
  <figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">acceptTcpHandler</span><span class="params">(aeEventLoop *el, <span class="keyword">int</span> fd, <span class="keyword">void</span> *privdata, <span class="keyword">int</span> mask)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">int</span> cport, cfd, max = MAX_ACCEPTS_PER_CALL;</span><br><span class="line">    <span class="keyword">char</span> cip[REDIS_IP_STR_LEN];</span><br><span class="line">    REDIS_NOTUSED(el);</span><br><span class="line">    REDIS_NOTUSED(mask);</span><br><span class="line">    REDIS_NOTUSED(privdata);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">while</span>(max--) &#123;</span><br><span class="line">        cfd = anetTcpAccept(server.neterr, fd, cip, <span class="keyword">sizeof</span>(cip), &amp;cport);</span><br><span class="line">        <span class="keyword">if</span> (cfd == ANET_ERR) &#123;</span><br><span class="line">            <span class="keyword">if</span> (errno != EWOULDBLOCK)</span><br><span class="line">                redisLog(REDIS_WARNING,</span><br><span class="line">                    <span class="string">"Accepting client connection: %s"</span>, server.neterr);</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        redisLog(REDIS_VERBOSE,<span class="string">"Accepted %s:%d"</span>, cip, cport);</span><br><span class="line">        acceptCommonHandler(cfd,<span class="number">0</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>并且通过调用acceptCommonHandler方法将调用createClient将客户端连接添加到epoll事件中，同时将readQueryFromClient方法绑定到rfileProc和wfileProc<br><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">redisClient *<span class="title">createClient</span><span class="params">(<span class="keyword">int</span> fd)</span> </span>&#123;</span><br><span class="line">    redisClient *c = zmalloc(<span class="keyword">sizeof</span>(redisClient));</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* passing -1 as fd it is possible to create a non connected client.</span></span><br><span class="line"><span class="comment">     * This is useful since all the Redis commands needs to be executed</span></span><br><span class="line"><span class="comment">     * in the context of a client. When commands are executed in other</span></span><br><span class="line"><span class="comment">     * contexts (for instance a Lua script) we need a non connected client. */</span></span><br><span class="line">    <span class="keyword">if</span> (fd != <span class="number">-1</span>) &#123;</span><br><span class="line">        anetNonBlock(<span class="literal">NULL</span>,fd);</span><br><span class="line">        anetEnableTcpNoDelay(<span class="literal">NULL</span>,fd);</span><br><span class="line">        <span class="keyword">if</span> (server.tcpkeepalive)</span><br><span class="line">            anetKeepAlive(<span class="literal">NULL</span>,fd,server.tcpkeepalive);</span><br><span class="line">        <span class="keyword">if</span> (aeCreateFileEvent(server.el,fd,AE_READABLE,</span><br><span class="line">            readQueryFromClient, c) == AE_ERR)</span><br><span class="line">        &#123;</span><br><span class="line">            close(fd);</span><br><span class="line">            zfree(c);</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">NULL</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    selectDb(c,<span class="number">0</span>);</span><br><span class="line">    c-&gt;id = server.next_client_id++;</span><br><span class="line">    c-&gt;fd = fd;</span><br><span class="line">    c-&gt;name = <span class="literal">NULL</span>;</span><br><span class="line">    c-&gt;bufpos = <span class="number">0</span>;</span><br><span class="line">    c-&gt;querybuf = sdsempty();</span><br><span class="line">    c-&gt;querybuf_peak = <span class="number">0</span>;</span><br><span class="line">    c-&gt;reqtype = <span class="number">0</span>;</span><br><span class="line">    c-&gt;argc = <span class="number">0</span>;</span><br><span class="line">    c-&gt;argv = <span class="literal">NULL</span>;</span><br><span class="line">    c-&gt;cmd = c-&gt;lastcmd = <span class="literal">NULL</span>;</span><br><span class="line">    c-&gt;multibulklen = <span class="number">0</span>;</span><br><span class="line">    c-&gt;bulklen = <span class="number">-1</span>;</span><br><span class="line">    c-&gt;sentlen = <span class="number">0</span>;</span><br><span class="line">    c-&gt;flags = <span class="number">0</span>;</span><br><span class="line">    c-&gt;ctime = c-&gt;lastinteraction = server.unixtime;</span><br><span class="line">    c-&gt;authenticated = <span class="number">0</span>;</span><br><span class="line">    c-&gt;replstate = REDIS_REPL_NONE;</span><br><span class="line">    c-&gt;repl_put_online_on_ack = <span class="number">0</span>;</span><br><span class="line">    c-&gt;reploff = <span class="number">0</span>;</span><br><span class="line">    c-&gt;repl_ack_off = <span class="number">0</span>;</span><br><span class="line">    c-&gt;repl_ack_time = <span class="number">0</span>;</span><br><span class="line">    c-&gt;slave_listening_port = <span class="number">0</span>;</span><br><span class="line">    c-&gt;reply = listCreate();</span><br><span class="line">    c-&gt;reply_bytes = <span class="number">0</span>;</span><br><span class="line">    c-&gt;obuf_soft_limit_reached_time = <span class="number">0</span>;</span><br><span class="line">    listSetFreeMethod(c-&gt;reply,decrRefCountVoid);</span><br><span class="line">    listSetDupMethod(c-&gt;reply,dupClientReplyValue);</span><br><span class="line">    c-&gt;btype = REDIS_BLOCKED_NONE;</span><br><span class="line">    c-&gt;bpop.timeout = <span class="number">0</span>;</span><br><span class="line">    c-&gt;bpop.keys = dictCreate(&amp;setDictType,<span class="literal">NULL</span>);</span><br><span class="line">    c-&gt;bpop.target = <span class="literal">NULL</span>;</span><br><span class="line">    c-&gt;bpop.numreplicas = <span class="number">0</span>;</span><br><span class="line">    c-&gt;bpop.reploffset = <span class="number">0</span>;</span><br><span class="line">    c-&gt;woff = <span class="number">0</span>;</span><br><span class="line">    c-&gt;watched_keys = listCreate();</span><br><span class="line">    c-&gt;pubsub_channels = dictCreate(&amp;setDictType,<span class="literal">NULL</span>);</span><br><span class="line">    c-&gt;pubsub_patterns = listCreate();</span><br><span class="line">    c-&gt;peerid = <span class="literal">NULL</span>;</span><br><span class="line">    listSetFreeMethod(c-&gt;pubsub_patterns,decrRefCountVoid);</span><br><span class="line">    listSetMatchMethod(c-&gt;pubsub_patterns,listMatchObjects);</span><br><span class="line">    <span class="keyword">if</span> (fd != <span class="number">-1</span>) listAddNodeTail(server.clients,c);</span><br><span class="line">    initClientMultiState(c);</span><br><span class="line">    <span class="keyword">return</span> c;</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">readQueryFromClient</span><span class="params">(aeEventLoop *el, <span class="keyword">int</span> fd, <span class="keyword">void</span> *privdata, <span class="keyword">int</span> mask)</span> </span>&#123;</span><br><span class="line">    redisClient *c = (redisClient*) privdata;</span><br><span class="line">    <span class="keyword">int</span> nread, readlen;</span><br><span class="line">    <span class="keyword">size_t</span> qblen;</span><br><span class="line">    REDIS_NOTUSED(el);</span><br><span class="line">    REDIS_NOTUSED(mask);</span><br><span class="line"></span><br><span class="line">    server.current_client = c;</span><br><span class="line">    readlen = REDIS_IOBUF_LEN;</span><br><span class="line">    <span class="comment">/* If this is a multi bulk request, and we are processing a bulk reply</span></span><br><span class="line"><span class="comment">     * that is large enough, try to maximize the probability that the query</span></span><br><span class="line"><span class="comment">     * buffer contains exactly the SDS string representing the object, even</span></span><br><span class="line"><span class="comment">     * at the risk of requiring more read(2) calls. This way the function</span></span><br><span class="line"><span class="comment">     * processMultiBulkBuffer() can avoid copying buffers to create the</span></span><br><span class="line"><span class="comment">     * Redis Object representing the argument. */</span></span><br><span class="line">    <span class="keyword">if</span> (c-&gt;reqtype == REDIS_REQ_MULTIBULK &amp;&amp; c-&gt;multibulklen &amp;&amp; c-&gt;bulklen != <span class="number">-1</span></span><br><span class="line">        &amp;&amp; c-&gt;bulklen &gt;= REDIS_MBULK_BIG_ARG)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">int</span> remaining = (<span class="keyword">unsigned</span>)(c-&gt;bulklen+<span class="number">2</span>)-sdslen(c-&gt;querybuf);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (remaining &lt; readlen) readlen = remaining;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    qblen = sdslen(c-&gt;querybuf);</span><br><span class="line">    <span class="keyword">if</span> (c-&gt;querybuf_peak &lt; qblen) c-&gt;querybuf_peak = qblen;</span><br><span class="line">    c-&gt;querybuf = sdsMakeRoomFor(c-&gt;querybuf, readlen);</span><br><span class="line">    nread = read(fd, c-&gt;querybuf+qblen, readlen);</span><br><span class="line">    <span class="keyword">if</span> (nread == <span class="number">-1</span>) &#123;</span><br><span class="line">        <span class="keyword">if</span> (errno == EAGAIN) &#123;</span><br><span class="line">            nread = <span class="number">0</span>;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            redisLog(REDIS_VERBOSE, <span class="string">"Reading from client: %s"</span>,strerror(errno));</span><br><span class="line">            freeClient(c);</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (nread == <span class="number">0</span>) &#123;</span><br><span class="line">        redisLog(REDIS_VERBOSE, <span class="string">"Client closed connection"</span>);</span><br><span class="line">        freeClient(c);</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (nread) &#123;</span><br><span class="line">        sdsIncrLen(c-&gt;querybuf,nread);</span><br><span class="line">        c-&gt;lastinteraction = server.unixtime;</span><br><span class="line">        <span class="keyword">if</span> (c-&gt;flags &amp; REDIS_MASTER) c-&gt;reploff += nread;</span><br><span class="line">        server.stat_net_input_bytes += nread;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        server.current_client = <span class="literal">NULL</span>;</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (sdslen(c-&gt;querybuf) &gt; server.client_max_querybuf_len) &#123;</span><br><span class="line">        sds ci = catClientInfoString(sdsempty(),c), bytes = sdsempty();</span><br><span class="line"></span><br><span class="line">        bytes = sdscatrepr(bytes,c-&gt;querybuf,<span class="number">64</span>);</span><br><span class="line">        redisLog(REDIS_WARNING,<span class="string">"Closing client that reached max query buffer length: %s (qbuf initial bytes: %s)"</span>, ci, bytes);</span><br><span class="line">        sdsfree(ci);</span><br><span class="line">        sdsfree(bytes);</span><br><span class="line">        freeClient(c);</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    processInputBuffer(c);</span><br><span class="line">    server.current_client = <span class="literal">NULL</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>通过以上代码片段我们可以看到，收完数据之后将会调用processInputBuffer处理客户端的请求。</p>
<p>还有疑惑的就是wfileProc是关联的什么方法？答案即将揭晓。<br>我们很容易就能想到对于该函数指针自然就是在需要发送应答包的时候了，如下所示在：<br><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">addReply</span><span class="params">(redisClient *c, robj *obj)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (prepareClientToWrite(c) != REDIS_OK) <span class="keyword">return</span>;</span><br><span class="line">...</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">prepareClientToWrite</span><span class="params">(redisClient *c)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (c-&gt;flags &amp; REDIS_LUA_CLIENT) <span class="keyword">return</span> REDIS_OK;</span><br><span class="line">    <span class="keyword">if</span> ((c-&gt;flags &amp; REDIS_MASTER) &amp;&amp;</span><br><span class="line">        !(c-&gt;flags &amp; REDIS_MASTER_FORCE_REPLY)) <span class="keyword">return</span> REDIS_ERR;</span><br><span class="line">    <span class="keyword">if</span> (c-&gt;fd &lt;= <span class="number">0</span>) <span class="keyword">return</span> REDIS_ERR; <span class="comment">/* Fake client */</span></span><br><span class="line">    <span class="keyword">if</span> (c-&gt;bufpos == <span class="number">0</span> &amp;&amp; listLength(c-&gt;reply) == <span class="number">0</span> &amp;&amp;</span><br><span class="line">        (c-&gt;replstate == REDIS_REPL_NONE ||</span><br><span class="line">         c-&gt;replstate == REDIS_REPL_ONLINE) &amp;&amp;</span><br><span class="line">        aeCreateFileEvent(server.el, c-&gt;fd, AE_WRITABLE,</span><br><span class="line">        sendReplyToClient, c) == AE_ERR) <span class="keyword">return</span> REDIS_ERR;</span><br><span class="line">    <span class="keyword">return</span> REDIS_OK;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>看到没同样是通过aeCreateFileEvent方法将sendReplyToClient关联到wfileProc.</p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://leeqx.github.io/2019/03/22/C数组内存分布/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Qinglin Li">
      <meta itemprop="description" content>
      <meta itemprop="image" content="https://avatars1.githubusercontent.com/u/931925?s=460&v=4">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="linux programer">
    </span>

    
      <header class="post-header">

        
        
          <h2 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2019/03/22/C数组内存分布/" itemprop="url">未命名</a></h2>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2019-03-22T10:37:35+08:00">
                2019-03-22
              </time>
            

            

            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h1 id="数组内存中分布情况"><a href="#数组内存中分布情况" class="headerlink" title="数组内存中分布情况"></a>数组内存中分布情况</h1><ol start="0">
<li>二维数组<br>注意栈中地址是从高地址向低地址生长：  </li>
</ol>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line">(gdb) p/x &amp;arr[<span class="number">0</span>][<span class="number">0</span>]</span><br><span class="line">$<span class="number">7</span> = <span class="number">0x7fffffffe440</span></span><br><span class="line">(gdb) p/x &amp;arr[<span class="number">0</span>][<span class="number">1</span>]</span><br><span class="line">$<span class="number">8</span> = <span class="number">0x7fffffffe444</span></span><br><span class="line">(gdb) p/x &amp;arr[<span class="number">0</span>][<span class="number">2</span>]</span><br><span class="line">$<span class="number">9</span> = <span class="number">0x7fffffffe448</span></span><br><span class="line">(gdb) p/x &amp;arr[<span class="number">0</span>][<span class="number">3</span>]</span><br><span class="line">$<span class="number">10</span> = <span class="number">0x7fffffffe44c</span></span><br><span class="line"></span><br><span class="line">(gdb) p/x &amp;arr[<span class="number">1</span>][<span class="number">0</span>]</span><br><span class="line">$<span class="number">11</span> = <span class="number">0x7fffffffe450</span></span><br><span class="line">(gdb) p/x &amp;arr[<span class="number">1</span>][<span class="number">1</span>]</span><br><span class="line">$<span class="number">12</span> = <span class="number">0x7fffffffe454</span></span><br><span class="line">(gdb) p/x &amp;arr[<span class="number">1</span>][<span class="number">2</span>]</span><br><span class="line">$<span class="number">13</span> = <span class="number">0x7fffffffe458</span></span><br><span class="line">(gdb) p/x &amp;arr[<span class="number">1</span>][<span class="number">3</span>]</span><br><span class="line">$<span class="number">14</span> = <span class="number">0x7fffffffe45c</span></span><br><span class="line"></span><br><span class="line">(gdb) p/x &amp;arr[<span class="number">2</span>][<span class="number">0</span>]</span><br><span class="line">$<span class="number">15</span> = <span class="number">0x7fffffffe460</span></span><br><span class="line">(gdb) p/x &amp;arr[<span class="number">2</span>][<span class="number">1</span>]</span><br><span class="line">$<span class="number">16</span> = <span class="number">0x7fffffffe464</span></span><br><span class="line">(gdb) p/x &amp;arr[<span class="number">2</span>][<span class="number">2</span>]</span><br><span class="line">$<span class="number">17</span> = <span class="number">0x7fffffffe468</span></span><br><span class="line">(gdb) p/x &amp;arr[<span class="number">2</span>][<span class="number">3</span>]</span><br><span class="line">$<span class="number">18</span> = <span class="number">0x7fffffffe46c</span></span><br><span class="line"></span><br><span class="line">(gdb) p/x &amp;arr[<span class="number">3</span>][<span class="number">0</span>]</span><br><span class="line">$<span class="number">19</span> = <span class="number">0x7fffffffe470</span></span><br><span class="line">(gdb) p/x &amp;arr[<span class="number">3</span>][<span class="number">1</span>]</span><br><span class="line">$<span class="number">20</span> = <span class="number">0x7fffffffe474</span></span><br><span class="line">(gdb) p/x &amp;arr[<span class="number">3</span>][<span class="number">2</span>]</span><br><span class="line">$<span class="number">21</span> = <span class="number">0x7fffffffe478</span></span><br><span class="line">(gdb) p/x &amp;arr[<span class="number">3</span>][<span class="number">3</span>]</span><br><span class="line">$<span class="number">22</span> = <span class="number">0x7fffffffe47c</span></span><br></pre></td></tr></table></figure>
<p>即如下图走向：<br><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">         <span class="number">0</span>     <span class="number">1</span>     <span class="number">2</span>    <span class="number">3</span>  </span><br><span class="line">    <span class="number">0</span>  -------------------&gt;  </span><br><span class="line">    <span class="number">1</span>  -------------------&gt;  </span><br><span class="line">    <span class="number">2</span>  -------------------&gt;  </span><br><span class="line">    <span class="number">3</span>  -------------------&gt;  </span><br><span class="line">```  </span><br><span class="line"><span class="number">0.</span> 一维数组在内存中的分布情况：</span><br><span class="line">```c</span><br><span class="line">(gdb) p/x &amp;a[<span class="number">0</span>]                             </span><br><span class="line">$<span class="number">1</span> = <span class="number">0x7fffffffe460</span></span><br><span class="line">(gdb) p/x &amp;a[<span class="number">1</span>]</span><br><span class="line">$<span class="number">2</span> = <span class="number">0x7fffffffe464</span></span><br><span class="line">(gdb) p/x &amp;a[<span class="number">2</span>]</span><br><span class="line">$<span class="number">3</span> = <span class="number">0x7fffffffe468</span></span><br><span class="line">(gdb) p/x &amp;a[<span class="number">3</span>]</span><br><span class="line">$<span class="number">4</span> = <span class="number">0x7fffffffe46c</span></span><br><span class="line">(gdb) p/x &amp;a[<span class="number">4</span>]</span><br><span class="line">$<span class="number">5</span> = <span class="number">0x7fffffffe470</span></span><br><span class="line">(gdb) p/x &amp;a[<span class="number">5</span>]</span><br><span class="line">$<span class="number">6</span> = <span class="number">0x7fffffffe474</span></span><br></pre></td></tr></table></figure></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">低地址            高地址</span><br><span class="line">a  <span class="number">0</span>    <span class="number">1</span>    <span class="number">2</span>    <span class="number">3</span>     <span class="number">4</span></span><br><span class="line">    ---------------------&gt;</span><br></pre></td></tr></table></figure>
<ol start="0">
<li><p>c中栈是由高地址向低地址延伸,堆则是从低地址想高地址延伸</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">  栈底</span><br><span class="line">___________</span><br><span class="line">|     a[<span class="number">5</span>]     |     高地址</span><br><span class="line">|     a[<span class="number">4</span>]     |</span><br><span class="line">|     a[<span class="number">3</span>]     |</span><br><span class="line">|     a[<span class="number">2</span>]     |</span><br><span class="line">|     a[<span class="number">1</span>]     |</span><br><span class="line">|     a[<span class="number">0</span>]     |      低地址 </span><br><span class="line">      栈顶</span><br></pre></td></tr></table></figure>
</li>
<li><p>C程序内存中的组织形式     </p>
</li>
</ol>
<pre><code class="c">【代码区    】  高地址
【静态数据区 】
【栈        】
 -----------
 -----------
 -----------
 -----------
【 堆       】 低地址
</code></pre>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://leeqx.github.io/2019/03/22/Home/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Qinglin Li">
      <meta itemprop="description" content>
      <meta itemprop="image" content="https://avatars1.githubusercontent.com/u/931925?s=460&v=4">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="linux programer">
    </span>

    
      <header class="post-header">

        
        
          <h2 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2019/03/22/Home/" itemprop="url">未命名</a></h2>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2019-03-22T10:37:35+08:00">
                2019-03-22
              </time>
            

            

            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h1 id="leeqx-github-io-http-leeqx-github-io"><a href="#leeqx-github-io-http-leeqx-github-io" class="headerlink" title="[leeqx.github.io] (http://leeqx.github.io)"></a>[leeqx.github.io] (<a href="http://leeqx.github.io">http://leeqx.github.io</a>)</h1><p>一起来，做点贡献吧~</p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://leeqx.github.io/2019/03/22/共享内存操作/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Qinglin Li">
      <meta itemprop="description" content>
      <meta itemprop="image" content="https://avatars1.githubusercontent.com/u/931925?s=460&v=4">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="linux programer">
    </span>

    
      <header class="post-header">

        
        
          <h2 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2019/03/22/共享内存操作/" itemprop="url">未命名</a></h2>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2019-03-22T10:37:35+08:00">
                2019-03-22
              </time>
            

            

            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h1 id="C共享内存"><a href="#C共享内存" class="headerlink" title="C共享内存"></a>C共享内存</h1><ol start="0">
<li><p>ftok —&gt;文件到key，保证唯一性，存放在keys中，并且通过下面的方法将对应的字符串设置到进程的环境变量中，<br>以便fork出来的进程的可以访问这些环境变量：  </p>
 <figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">i = setenv(env_strings[apptype],envstr,<span class="number">1</span>);</span><br></pre></td></tr></table></figure>
</li>
<li><p>获取shm_id  </p>
 <figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">shm_id = shmget (keys[apptype],<span class="keyword">sizeof</span>(struct mem_blk),IPC_CREAT| IPC_EXCL|<span class="number">0x1ff</span>);</span><br></pre></td></tr></table></figure>
</li>
<li><p>更改shm_id相关的属性   </p>
 <figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">shmctl(shm_id,IPC_STAT,&amp;shmbuf);</span><br><span class="line">shmbuf.shm_perm.mode &amp;= SHM_R| SHM_W;</span><br><span class="line">shmctl(shm_id,IPC_SET,&amp;shmbuf);</span><br></pre></td></tr></table></figure>
</li>
<li><p>获取相应的共享内存，并且初始化共享内存为0 </p>
 <figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">pshm = (<span class="keyword">int8_t</span>*)shmat(shm_id,<span class="literal">NULL</span>,<span class="number">0</span>);</span><br></pre></td></tr></table></figure>
</li>
<li><p>共享内存的删除：  </p>
 <figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">shmctl(shm_id, IPC_RMID, <span class="number">0</span>)</span><br></pre></td></tr></table></figure>
</li>
<li><p>（在其他进程子进程）连接共享内存：</p>
 <figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">envstr = getenv(env_strings[apptype]);</span><br><span class="line">shm_id = atoi(envstr);</span><br><span class="line">pshm = ( <span class="keyword">int8_t</span>*)shmat(shm_id,<span class="literal">NULL</span>,<span class="number">0</span>);</span><br></pre></td></tr></table></figure>
</li>
<li><p>共享内存的读写：<br>通过6得到的pshm共享内存指针就可以往该共享内存块上进行读写</p>
</li>
<li><p>共享内存操作命令：ipcs、ipcrm</p>
<ol start="0">
<li>ipcs -m 显示共享内存：<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">------ Shared Memory Segments --------  </span><br><span class="line">key        shmid      owner      perms      bytes      nattch     status        </span><br><span class="line">0x740180a7 2686976    root      600        4          0                         </span><br><span class="line">0x740a800c 3642337    root      600        4          0                           </span><br><span class="line">0x00000000 5644578    nobody    600        16777216   129        dest         </span><br><span class="line">0x740aa00b 3609571    root      600        4          0                       </span><br><span class="line">0x00000000 5677348    nobody    600        16777216   257        dest         </span><br><span class="line">0x00000000 5660117    nobody    600        16777216   257        dest         </span><br><span class="line">0x00000bde 5642887    root      666        63120208   1</span><br></pre></td></tr></table></figure>
</li>
</ol>
<p>字段|说明<br>—-|—-<br>key |是用来唯一标识这段共享内存的唯一标示；<br>shmid|是shmget返回的共享内存id；<br>owner|创建共享内存的用户<br>perms|读写权限<br>Bytes|标示key这段共享内存大小<br>nattach|表示attch到这段共享内存的数量</p>
<ol start="0">
<li>ipcrm -m shmid removes the shared memory segment identified by shmid after the last detach is performed.</li>
</ol>
</li>
</ol>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://leeqx.github.io/2019/03/22/CPP设计思维新模式/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Qinglin Li">
      <meta itemprop="description" content>
      <meta itemprop="image" content="https://avatars1.githubusercontent.com/u/931925?s=460&v=4">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="linux programer">
    </span>

    
      <header class="post-header">

        
        
          <h2 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2019/03/22/CPP设计思维新模式/" itemprop="url">未命名</a></h2>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2019-03-22T10:37:35+08:00">
                2019-03-22
              </time>
            

            

            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h1 id="CPP设计思维新模式"><a href="#CPP设计思维新模式" class="headerlink" title="CPP设计思维新模式"></a>CPP设计思维新模式</h1><p>===</p>
<ol start="0">
<li><p>系统架构的一个主要基本原则是以设计实现某些原则 </p>
</li>
<li><p>特化   </p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="keyword">template</span> &lt;<span class="class"><span class="keyword">class</span> <span class="title">T</span>,<span class="title">class</span> <span class="title">U</span>&gt; </span></span><br><span class="line"><span class="class"></span></span><br><span class="line"><span class="class"><span class="title">class</span> <span class="title">Tt</span>&#123;</span>&#125;;</span><br></pre></td></tr></table></figure>
<p>特化其中一个参数 </p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">template</span> &lt;<span class="class"><span class="keyword">class</span> <span class="title">U</span>&gt; </span></span><br><span class="line"><span class="class"></span></span><br><span class="line"><span class="class"><span class="title">class</span> <span class="title">Tt</span>&lt;widget w&gt;&#123;</span>&#125;;</span><br></pre></td></tr></table></figure>
</li>
</ol>
<ol start="0">
<li><p>关于protected 析构 </p>
<p> 采用proected 权限的析构目的是使得当删除基类指针时（该指针指向了派生类对象），<br> 使其不调用派生类的析构（因为权限问题，无法访问派生类的析构方法）；<br> 这样做如果该类中不存在其他virtual类型的方法，将避免增加vptr 导致性能得到降低。<br> 当然如果希望delete基类指针时能够调用派生类的析构，那么基类的析构需要声明为<br> virtual，同时这不可避免的导致内存性能下降问题。   </p>
</li>
<li><p>关于private、protected 的构造方法 </p>
<p>对于这两种权限的构造方法，由于无法在外部调用所以将导致在类外无法构建对象。<br>但是protected在其子类中可以构造。所以如果存在场景只允许其派生类构造对象那么<br>可以将构造方法声明为protected。如果是private 那么只能在该类内部使用。例子：   </p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">A</span> </span></span><br><span class="line"><span class="class"></span></span><br><span class="line"><span class="class">&#123;</span> </span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span>: </span><br><span class="line"></span><br><span class="line">A()&#123;  &#125; </span><br><span class="line"></span><br><span class="line">~A()&#123; &#125; </span><br><span class="line"></span><br><span class="line"> </span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span>: </span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">Instance</span><span class="params">()</span><span class="comment">//类A的内部的一个函数 </span></span></span><br><span class="line"><span class="function"></span></span><br><span class="line"><span class="function"></span>&#123; </span><br><span class="line"></span><br><span class="line">A a; </span><br><span class="line"></span><br><span class="line">&#125; </span><br><span class="line"></span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<p>上面的代码是能通过编译的。上面代码里的Instance函数就是类A的内部的一个函数。<br>Instance函数体里就构建了一个A的对象。<br>但是，这个Instance函数还是不能够被外面调用的。为什么呢？<br>如果要调用Instance函数，必须有一个对象被构造出来。但是构造函数被声明为private<br>的了。外部不能直接构造一个对象出来。   </p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">A aObj; <span class="comment">// 编译通不过 </span></span><br><span class="line">aObj.Instance();</span><br></pre></td></tr></table></figure>
<p>但是，如果Instance是一个static静态函数的话，就可以不需要通过一个对象，而可以直接被调用。如下： </p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">A</span> </span></span><br><span class="line"><span class="class"></span></span><br><span class="line"><span class="class">&#123;</span> </span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span>: </span><br><span class="line"></span><br><span class="line">A():data(<span class="number">10</span>)&#123; <span class="built_in">cout</span> &lt;&lt; <span class="string">"A"</span> &lt;&lt; <span class="built_in">endl</span>; &#125; </span><br><span class="line"></span><br><span class="line">~A()&#123; <span class="built_in">cout</span> &lt;&lt; <span class="string">"~A"</span> &lt;&lt; <span class="built_in">endl</span>; &#125; </span><br><span class="line"></span><br><span class="line"> </span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span>: </span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">static</span> A&amp; <span class="title">Instance</span><span class="params">()</span> </span></span><br><span class="line"><span class="function"></span></span><br><span class="line"><span class="function"></span>&#123; </span><br><span class="line"></span><br><span class="line"><span class="keyword">static</span> A a; </span><br><span class="line"></span><br><span class="line"><span class="keyword">return</span> a; </span><br><span class="line"></span><br><span class="line">&#125; </span><br><span class="line"></span><br><span class="line"> </span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">Print</span><span class="params">()</span> </span></span><br><span class="line"><span class="function"></span></span><br><span class="line"><span class="function"></span>&#123; </span><br><span class="line"></span><br><span class="line"><span class="built_in">cout</span> &lt;&lt; data &lt;&lt; <span class="built_in">endl</span>; </span><br><span class="line"></span><br><span class="line">&#125; </span><br><span class="line"><span class="keyword">private</span>: </span><br><span class="line"><span class="keyword">int</span> data; </span><br><span class="line"></span><br><span class="line">&#125;; </span><br><span class="line">A&amp; ra = A::Instance(); </span><br><span class="line"></span><br><span class="line">ra.Print();</span><br></pre></td></tr></table></figure>
<p>或者如下： </p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"> <span class="class"><span class="keyword">class</span> <span class="title">A</span> </span></span><br><span class="line"><span class="class"> </span></span><br><span class="line"><span class="class"> &#123;</span> </span><br><span class="line"> </span><br><span class="line"> <span class="keyword">private</span>: </span><br><span class="line"> </span><br><span class="line"> A()&#123;  &#125; </span><br><span class="line"> </span><br><span class="line"> ~A()&#123; &#125; </span><br><span class="line"> </span><br><span class="line">  </span><br><span class="line"> </span><br><span class="line"> <span class="keyword">public</span>: </span><br><span class="line"> </span><br><span class="line"> <span class="function">Static A* <span class="title">Instance</span><span class="params">()</span><span class="comment">//类A的内部的一个函数 </span></span></span><br><span class="line"><span class="function"> </span></span><br><span class="line"><span class="function"> </span>&#123; </span><br><span class="line"> </span><br><span class="line"> Return <span class="keyword">new</span> A; </span><br><span class="line"> </span><br><span class="line"> &#125; </span><br><span class="line"> </span><br><span class="line"> &#125;; </span><br><span class="line">A* pA = A::Instance();</span><br></pre></td></tr></table></figure>
<p>同时采用这种技术，可以将operator= 声明为private 但是没有具体实现，<br>这样子可以禁止一个类的外部用户对这个类的对象进行复制动作。   </p>
</li>
<li><p>智能指针   </p>
<ol start="0">
<li>拷贝、赋值是摧毁式拷贝   <figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line">Template&lt;<span class="keyword">typename</span> T&gt; </span><br><span class="line"></span><br><span class="line"> <span class="class"><span class="keyword">class</span> <span class="title">SmartPtr</span> </span></span><br><span class="line"><span class="class"></span></span><br><span class="line"><span class="class">&#123;</span> </span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span>： </span><br><span class="line"></span><br><span class="line">   SmartPtr(SmartPtr &amp;src) </span><br><span class="line"></span><br><span class="line">&#123; </span><br><span class="line"></span><br><span class="line">  <span class="keyword">this</span>-&gt;ptr = src.ptr; </span><br><span class="line"></span><br><span class="line">  src.ptr = <span class="literal">NULL</span>;<span class="comment">// 摧毁 </span></span><br><span class="line"></span><br><span class="line">&#125; </span><br><span class="line"></span><br><span class="line">    SmartPtr&amp; <span class="keyword">operator</span>=(SmartPtr &amp;src) </span><br><span class="line"></span><br><span class="line">&#123; </span><br><span class="line"></span><br><span class="line">If(<span class="keyword">this</span> != &amp;src) </span><br><span class="line"></span><br><span class="line">&#123; </span><br><span class="line"></span><br><span class="line">This-&gt;ptr = src.ptr; </span><br><span class="line"></span><br><span class="line">Src.ptr = <span class="literal">NULL</span>; <span class="comment">// 摧毁 </span></span><br><span class="line"></span><br><span class="line">&#125; </span><br><span class="line"></span><br><span class="line"> </span><br><span class="line"></span><br><span class="line">&#125; </span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span>： </span><br><span class="line"></span><br><span class="line">T* ptr; </span><br><span class="line"></span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
</li>
</ol>
</li>
</ol>
<ol start="0">
<li><p>取址操作符 </p>
<p>其目的是为了smartpoint 能够跟 dumb pointers 尽可能相似 </p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line">Template&lt;<span class="keyword">typename</span> T&gt; </span><br><span class="line"></span><br><span class="line">Class SmartPtr </span><br><span class="line"></span><br><span class="line">&#123; </span><br><span class="line"></span><br><span class="line">   <span class="keyword">public</span>: </span><br><span class="line"></span><br><span class="line"> T** <span class="keyword">operator</span>&amp;() </span><br><span class="line"></span><br><span class="line">&#123; </span><br><span class="line"></span><br><span class="line">Return &amp;ptr; </span><br><span class="line"></span><br><span class="line">&#125; </span><br><span class="line"></span><br><span class="line">Private: </span><br><span class="line"></span><br><span class="line">T* ptr; </span><br><span class="line"></span><br><span class="line">&#125;; </span><br><span class="line"></span><br><span class="line"> </span><br><span class="line"><span class="comment">// 有了取址操作符之后下面的运作就会成立： </span></span><br><span class="line"></span><br><span class="line"><span class="function">Void <span class="title">Fun</span><span class="params">(Widget** pW)</span></span>; </span><br><span class="line"></span><br><span class="line">SmartPtr&lt;Widget&gt; spW(<span class="keyword">new</span> Widget()); </span><br><span class="line"></span><br><span class="line">Fun(&amp;spW);</span><br></pre></td></tr></table></figure>
<p>但是不建议重载operator&amp; </p>
</li>
</ol>
<ol start="0">
<li><p>隐式转换 至原始指针 </p>
<p>用户自定义转换符重载，该符号重载不能写明返回类型，其返回采用operator 后面的类型，<br>格式如下：TYPE为用户自定义类型 </p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">operator</span> <span class="title">TYPE</span><span class="params">()</span> </span></span><br><span class="line"><span class="function"> </span>&#123; </span><br><span class="line"> &#125;</span><br></pre></td></tr></table></figure>
<p>例如：  </p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">Class c </span><br><span class="line"></span><br><span class="line">&#123; </span><br><span class="line"></span><br><span class="line">Operator <span class="keyword">bool</span>（） </span><br><span class="line"></span><br><span class="line">｛ </span><br><span class="line">Return  <span class="literal">true</span>; </span><br><span class="line">｝ </span><br><span class="line"></span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<p>为了能够使得我们自定义的数据自行转换，我们需要重载转换符。 </p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">Template&lt;<span class="keyword">typename</span> T&gt; </span><br><span class="line"></span><br><span class="line">Class SmartPtr </span><br><span class="line"></span><br><span class="line">&#123; </span><br><span class="line"></span><br><span class="line">  <span class="keyword">public</span>: </span><br><span class="line"></span><br><span class="line">    <span class="keyword">operator</span> T*() </span><br><span class="line"></span><br><span class="line">   &#123; </span><br><span class="line"></span><br><span class="line">Return ptr; </span><br><span class="line"></span><br><span class="line">   &#125; </span><br><span class="line"></span><br><span class="line">   <span class="comment">//… </span></span><br><span class="line"></span><br><span class="line">   <span class="keyword">private</span>: </span><br><span class="line"></span><br><span class="line">        T* ptr; </span><br><span class="line"></span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<p>有了该转换之后，下面的代码就可以编译： </p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">Void  <span class="title">Fun</span><span class="params">(Widget  *pw)</span></span>; </span><br><span class="line">SmartPtr&lt;Widget&gt; sp(<span class="keyword">new</span> Widget()); </span><br><span class="line">Fun(sp);</span><br></pre></td></tr></table></figure>
<p>但是与此同时也引入了新问题：外部直接对智能指针进行delete操作，那么我们的职能指针久形同虚设<br>所以为了避免这个问题，我们采用歧义性，使得对delete的操作编译无法通过，便可达到目的：   </p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line">Template&lt;<span class="keyword">typename</span> T&gt; </span><br><span class="line"></span><br><span class="line">Class SmartPtr </span><br><span class="line"></span><br><span class="line">&#123; </span><br><span class="line"></span><br><span class="line">   <span class="keyword">public</span>: </span><br><span class="line"></span><br><span class="line">Operator T*() </span><br><span class="line"></span><br><span class="line">&#123;  </span><br><span class="line"></span><br><span class="line">   <span class="keyword">return</span> ptr; </span><br><span class="line"></span><br><span class="line">&#125; </span><br><span class="line"></span><br><span class="line">Operator <span class="keyword">void</span>*() </span><br><span class="line"></span><br><span class="line">&#123; </span><br><span class="line"></span><br><span class="line">Return ptr; </span><br><span class="line"></span><br><span class="line">     &#125; </span><br><span class="line">… </span><br><span class="line"></span><br><span class="line">Private: </span><br><span class="line"></span><br><span class="line">   T* ptr; </span><br><span class="line"></span><br><span class="line">&#125;; </span><br><span class="line"></span><br><span class="line">SmartPtr&lt;Widget&gt; sp(<span class="keyword">new</span> Widget()); </span><br><span class="line">Delete sp; <span class="comment">//compile error</span></span><br></pre></td></tr></table></figure>
</li>
<li><p>相等性 不等性<br>最好的方法，完整、可靠的方法：采用完全一致的做法，分别为每个操作法定义一份重载： </p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br></pre></td><td class="code"><pre><span class="line">Template&lt;<span class="keyword">typename</span> T&gt; </span><br><span class="line"></span><br><span class="line">Class SmartPtr </span><br><span class="line"></span><br><span class="line">&#123; </span><br><span class="line"></span><br><span class="line">Public: </span><br><span class="line"></span><br><span class="line"> <span class="keyword">bool</span> <span class="keyword">operator</span> !() <span class="keyword">const</span> <span class="comment">// Enable "if (!sp) …" </span></span><br><span class="line"></span><br><span class="line">&#123; </span><br><span class="line"></span><br><span class="line">     <span class="keyword">return</span> ptr== <span class="literal">NULL</span>; </span><br><span class="line"></span><br><span class="line">&#125; </span><br><span class="line"></span><br><span class="line"> </span><br><span class="line"></span><br><span class="line">Inline <span class="keyword">friend</span> <span class="keyword">bool</span> <span class="keyword">operator</span> == (<span class="keyword">const</span> SmartPtr&lt;T&gt; &amp;lhr, <span class="keyword">const</span> T* rhs) </span><br><span class="line"></span><br><span class="line">&#123; </span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> lhs.ptr == rhs; </span><br><span class="line"></span><br><span class="line"> &#125; </span><br><span class="line"></span><br><span class="line"> </span><br><span class="line"></span><br><span class="line">Inline <span class="keyword">friend</span> <span class="keyword">bool</span> <span class="keyword">operator</span> == ( <span class="keyword">const</span> T* lhs, <span class="keyword">const</span> SmartPtr&lt;T&gt; &amp;rhs) </span><br><span class="line"></span><br><span class="line">&#123; </span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> lhs == rhs.ptr; </span><br><span class="line"></span><br><span class="line">&#125; </span><br><span class="line"></span><br><span class="line"> </span><br><span class="line"></span><br><span class="line">Inline <span class="keyword">friend</span> <span class="keyword">bool</span> <span class="keyword">operator</span> != (<span class="keyword">const</span> SmartPtr&lt;T&gt; &amp;lhr,<span class="keyword">const</span> T* rhs) </span><br><span class="line"></span><br><span class="line">&#123; </span><br><span class="line"></span><br><span class="line">   <span class="keyword">return</span> lhs.ptr != rhs; </span><br><span class="line"></span><br><span class="line">&#125; </span><br><span class="line">Inline <span class="keyword">friend</span> <span class="keyword">bool</span> <span class="keyword">operator</span> != (<span class="keyword">const</span> T* lhs,<span class="keyword">const</span> SmartPtr&lt;T&gt; &amp; rhs) </span><br><span class="line"></span><br><span class="line">&#123; </span><br><span class="line">Return lhs != rhs.ptr; </span><br><span class="line"></span><br><span class="line">&#125; </span><br><span class="line">… </span><br><span class="line"></span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<p>下面的代码就可以运作了： </p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">SmartPtr &lt;Widget&gt; sp1,sp2; </span><br><span class="line">Widget *p; </span><br><span class="line"></span><br><span class="line">If(sp1) </span><br><span class="line">..</span><br><span class="line"></span><br><span class="line">If(!sp1) </span><br><span class="line">.. </span><br><span class="line"></span><br><span class="line">If(sp1==<span class="literal">NULL</span>) </span><br><span class="line"></span><br><span class="line">.. </span><br><span class="line"></span><br><span class="line">If (sp1==sp2) </span><br><span class="line"></span><br><span class="line">… </span><br><span class="line"></span><br><span class="line">If(sp1==p) </span><br><span class="line"></span><br><span class="line">… </span><br><span class="line"></span><br><span class="line">If(p==sp1)</span><br></pre></td></tr></table></figure>
</li>
</ol>
<p>  但至此还还不完美，如果提供一个“转型之ptr 型别”的自动转换式，还是存在歧义<br>  。假设一个Base class 以及一个从base 继承而来的Derive class 那么下面的代码还存在歧义性：<br>  <figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">SmartPtr&lt;Base&gt; sp; </span><br><span class="line"></span><br><span class="line">Derived *p; </span><br><span class="line"></span><br><span class="line">If(sp==p) <span class="comment">//以上重载方法，存在的歧义：（Base*)sp == (Base*)p   and operator == (sp,(Base*)p) </span></span><br><span class="line"></span><br><span class="line">&#123; </span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>  为此我们需要的对上面重载的比较方法添加template版本 </p>
  <figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line">Template&lt;<span class="keyword">typename</span> T&gt; </span><br><span class="line"></span><br><span class="line">Class SmartPtr </span><br><span class="line"></span><br><span class="line">&#123; </span><br><span class="line"></span><br><span class="line"> <span class="keyword">public</span>: </span><br><span class="line"></span><br><span class="line">        …<span class="comment">//同上（非template版本） </span></span><br><span class="line"></span><br><span class="line"><span class="keyword">template</span>&lt;<span class="keyword">typename</span> U&gt; </span><br><span class="line"></span><br><span class="line"><span class="keyword">inline</span> <span class="keyword">friend</span> <span class="keyword">bool</span> <span class="keyword">operator</span> == (<span class="keyword">const</span> SmartPtr&lt;U&gt; &amp;lhr,<span class="keyword">const</span> U* rhs) </span><br><span class="line"></span><br><span class="line">&#123; </span><br><span class="line"></span><br><span class="line">Return lhs.ptr == rhs; </span><br><span class="line"></span><br><span class="line">&#125; </span><br><span class="line"></span><br><span class="line">Template &lt;<span class="keyword">typename</span> U&gt; </span><br><span class="line"></span><br><span class="line"> <span class="keyword">inline</span> <span class="keyword">friend</span> <span class="keyword">bool</span> <span class="keyword">operator</span> == (<span class="keyword">const</span> U*lhs,<span class="keyword">const</span> SmartPtr&lt;U&gt;&amp;rhs) </span><br><span class="line"></span><br><span class="line">&#123; </span><br><span class="line"></span><br><span class="line">Return lhs == rhs.ptr; </span><br><span class="line"></span><br><span class="line">&#125; </span><br><span class="line"></span><br><span class="line">…其他的类似 </span><br><span class="line"></span><br><span class="line"> </span><br><span class="line"></span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<p>  但是至此依然不完美：<br>  因为：<br>  <figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">SmartPtr&lt;Apple&gt; sp1; </span><br><span class="line"></span><br><span class="line">SmartPtr &lt;Oragne&gt;sp2; </span><br><span class="line">If( sp1==sp2)   <span class="comment">//存在歧义</span></span><br></pre></td></tr></table></figure></p>
<p>  为了消除该歧义，我们还要：<br>  <figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">Template &lt;<span class="keyword">typename</span> T&gt; </span><br><span class="line"></span><br><span class="line">Class SmartPtr </span><br><span class="line"></span><br><span class="line">&#123; </span><br><span class="line"></span><br><span class="line">  <span class="keyword">public</span>: </span><br><span class="line"></span><br><span class="line">        … 同上…… </span><br><span class="line"></span><br><span class="line">  <span class="keyword">template</span>&lt;<span class="keyword">typename</span> T&gt; </span><br><span class="line"></span><br><span class="line"> <span class="keyword">bool</span> <span class="keyword">operator</span> == (<span class="keyword">const</span> SmartPtr&lt;U&gt; &amp;rhs) <span class="keyword">const</span> </span><br><span class="line"></span><br><span class="line">&#123; </span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> ptr == rhs.ptr; </span><br><span class="line"></span><br><span class="line">&#125; </span><br><span class="line"></span><br><span class="line">…其他的操作符于此类似…. </span><br><span class="line"></span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure></p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://leeqx.github.io/2019/03/22/Iptables/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Qinglin Li">
      <meta itemprop="description" content>
      <meta itemprop="image" content="https://avatars1.githubusercontent.com/u/931925?s=460&v=4">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="linux programer">
    </span>

    
      <header class="post-header">

        
        
          <h2 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2019/03/22/Iptables/" itemprop="url">未命名</a></h2>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2019-03-22T10:37:35+08:00">
                2019-03-22
              </time>
            

            

            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h1 id="iptables-操作"><a href="#iptables-操作" class="headerlink" title="iptables 操作"></a>iptables 操作</h1><ol start="0">
<li>相应的配置文件在：/etc/sysconfig/iptables  </li>
<li><p>可通过如下命令查看 iptables配置  </p>
<figure class="highlight plain"><figcaption><span>-t filter -L```  </span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">    ````  </span><br><span class="line">        [root@dell sysconfig]# iptables -t filter -L  </span><br><span class="line">        Chain INPUT (policy ACCEPT)</span><br><span class="line">        target     prot opt source               destination        </span><br><span class="line">        RH-Firewall-1-INPUT  all  --  anywhere             anywhere           </span><br><span class="line">        </span><br><span class="line">        Chain FORWARD (policy ACCEPT)</span><br><span class="line">        target     prot opt source               destination        </span><br><span class="line">        RH-Firewall-1-INPUT  all  --  anywhere             anywhere           </span><br><span class="line">        </span><br><span class="line">        Chain OUTPUT (policy ACCEPT)</span><br><span class="line">        target     prot opt source               destination        </span><br><span class="line">        </span><br><span class="line">        Chain RH-Firewall-1-INPUT (2 references)</span><br><span class="line">        target     prot opt source               destination        </span><br><span class="line">        ACCEPT     all  --  anywhere             anywhere           </span><br><span class="line">        ACCEPT     icmp --  anywhere             anywhere            icmp any</span><br><span class="line">        ACCEPT     ipv6-crypt--  anywhere             anywhere           </span><br><span class="line">        ACCEPT     ipv6-auth--  anywhere             anywhere           </span><br><span class="line">        ACCEPT     udp  --  anywhere             224.0.0.251         udp dpt:5353</span><br><span class="line">        ACCEPT     udp  --  anywhere             anywhere            udp dpt:ipp</span><br><span class="line">        ACCEPT     all  --  anywhere             anywhere            state RELATED,ESTABLISHED</span><br><span class="line">        ACCEPT     tcp  --  anywhere             anywhere            state NEW tcp dpt:ssh</span><br><span class="line">        ACCEPT     tcp  --  anywhere             anywhere            state NEW tcp dpt:http</span><br><span class="line">        ACCEPT     tcp  --  anywhere             anywhere            state NEW tcp dpt:ftp</span><br><span class="line">        REJECT     all  --  anywhere             anywhere            reject-with icmp-host-prohibited </span><br><span class="line">    ````    </span><br><span class="line">0. 查看虚拟ip  </span><br><span class="line">```ip -f inet addr</span><br></pre></td></tr></table></figure>
</li>
<li><p>重启iptables<br><code>/etc/init.d/iptables restart</code></p>
</li>
<li><p>当一个server ip 能够ping的通，但是telnet对应的端口连不上，且服务器上本地telnet正常，那么很有可能是<br>iptable限制端口的访问</p>
</li>
</ol>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://leeqx.github.io/2019/03/22/TCP_IP编程读书笔记/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Qinglin Li">
      <meta itemprop="description" content>
      <meta itemprop="image" content="https://avatars1.githubusercontent.com/u/931925?s=460&v=4">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="linux programer">
    </span>

    
      <header class="post-header">

        
        
          <h2 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2019/03/22/TCP_IP编程读书笔记/" itemprop="url">未命名</a></h2>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2019-03-22T10:37:35+08:00">
                2019-03-22
              </time>
            

            

            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h1 id="TCP-IP-编程读书笔记"><a href="#TCP-IP-编程读书笔记" class="headerlink" title="TCP/IP 编程读书笔记"></a>TCP/IP 编程读书笔记</h1><hr>
<ol start="0">
<li>**TCP/IPd定时器种类、个数<br><code>4种定时器、7个</code><br>重传计时器：Retransmission Timer<br>坚持计时器：Persistent Timer<br>保活计时器：Keeplive Timer<br>时间等待计时器：Time_Wait Timer  </li>
<li><p><strong>TCP/IP是一种流协议</strong>  </p>
<blockquote>
<p> 意味着数据是以字节流的形式传递给接收者，没有固定的“报文”或者“报文边界”。<br>Send函数只是将数据复制到发送端的协议栈中，然后就返回。至于要发送多少数据由TCP决定（前提是tcpsocket）。<br>尽管数据是以IP分组的形式传输的，但是分组中的数据量与send调用中传递的TCP多少数据并没有直接关系。而且程序中<br>没有什么可靠的方法是可以判断数据是如何分组的，因为在连词recv调用之间可能会有多个分组到来。TCP会记录它发送<br>多少字节以及确认的字节，但它不会记录这些字节是如何分组的。实际上分组重传丢失的分组的时候传送的数据可能比原来<br>的多一些或者少一些。</p>
</blockquote>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">主机A---M2-----M1-----主机B</span><br></pre></td></tr></table></figure>
<blockquote>
<p>在接收端，对于调用recv，都不会对tcp发送给他的数量做任何假设。对于接收端读取第一条报文可能有四种结果。  </p>
<ol start="0">
<li>没有数据可读，应用程序阻塞（没有设置非阻塞标识位）或者返回错误说明没有数据可读（设置非阻塞位）</li>
<li>应用程序只读取了M1中部分报文而不是全部</li>
<li>应用程序获取了报文M1中所有的数据，除此之外没有任何其他内容</li>
<li>应用程序获取报文M1的所有数据，以及报文M2的部分或者全部数据</li>
</ol>
</blockquote>
</li>
<li><p><strong>理解TCP写操作</strong></p>
<ol start="0">
<li><strong>从应用程序的角度看写操作(写操作返回错误)</strong><ol start="0">
<li>套接字描述符无效</li>
<li>使用Send及其兄弟函数时文件描述符指向的不是套接字</li>
<li>调用中制定的套接字不存在或者未连接</li>
<li>缓冲地址参数指向无效地址</li>
</ol>
</li>
<li><p><strong>从TCP角度看写操作</strong>  </p>
<blockquote>
<p>写操作负责将数据从应用程序的写缓冲区搬移到内核中去，并通知TCP有来自应用程序的新数据需要处理。</p>
<ol start="0">
<li>第一种流量控制算法被称为<strong>慢启动</strong><br>“慢慢的”将向网络发送数据的速率增加到一个门限值。</li>
<li>TCP输出例程，在符合下列某一项数据就会被传送出去：<ol start="0">
<li>可以发送一个完整的MSS尺寸的段</li>
<li>连接空闲，并且可以清空发送缓冲区</li>
<li>Nagle 算法被禁止，并且可以清空发送缓冲区</li>
<li>有紧急数据需要发送</li>
<li>有一小段“暂时”无法发送的数据</li>
<li>对等实体的接受窗口至少是半开的</li>
<li>需要重传一个段</li>
<li>需要为来自对等实体的数据传回一个ACK</li>
<li>需要发布一次窗口更新</li>
</ol>
</li>
</ol>
</blockquote>
</li>
</ol>
</li>
<li><p><strong>理解TCP的有序释放操作</strong>  </p>
<ol start="0">
<li>连接建立阶段   </li>
<li>数据传输阶段  </li>
<li>连接拆除阶段  </li>
</ol>
<blockquote>
<p>链接的一端完成了数据的发送，并将此事通知对等实体，但同时仍然在接收数据。因为<br>TCP连接是全双工的，而且一个方向的数据流与另一个方向的数据流是相互独立的，所以可能会出现这种情况。  </p>
</blockquote>
</li>
<li><p><strong>shutdown调用有乾坤</strong> </p>
   <figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">shutdown</span><span class="params">(<span class="keyword">int</span> s,<span class="keyword">int</span> how)</span></span></span><br></pre></td></tr></table></figure>
<pre><code>  how| 动作|
---|----|
SHUT_RD(0)|关闭连接的接收端|
SHUT_WT(1)|关闭连接的发送端|
SHUT_RDWR(2)|两端都关闭|
</code></pre><p>  <code>shutdown(s,2)</code> 等效于<code>close(s)</code></p>
<blockquote>
<p>有序释放的目的是确保两端都能在连接拆除之前收到所有来自其对等实体的数据。  </p>
</blockquote>
</li>
<li><p><strong>文件描述符就绪的条件</strong>  </p>
<ol start="0">
<li><strong>socket可读</strong>  <ol start="0">
<li>socket 内核接收缓存区中的字节数大于或者等于其低水位标记SO_RCVLOWAT。此时我们可以无阻塞的读该socket，并且读取操作返回的字节大于0</li>
<li>socket通信的对方关闭连接。此时对socket的读操作将返回0.</li>
<li>监听socket上有新的连接请求。</li>
<li>socket 上有未处理的错误，此时我们可以使用getsockopt来读取和清除该错误。</li>
</ol>
</li>
<li><p><strong>socket可写</strong></p>
<ol start="0">
<li>socket 内核发送缓存区中的可用字节数大于或者等于其低水位标记SO_SNDLOWAT。此时我们可以无阻塞的写该socket，并且写操作返回的字节数大于0.</li>
<li>socket的写操作被关闭，对写操作被关闭的socket执行写操作将处罚一个SIGPIPE信号</li>
<li>socket使用非阻塞connect 连接成功或者失败（超时)之后</li>
<li>socket上有未处理的错误，此时我们可以使用getsockopt来读取和清除该错误</li>
</ol>
<p>注意：网络程序中select能处理的异常情况只有一种：socket接收带外数据。（MSG_OOB)</p>
</li>
</ol>
</li>
<li><p>accept 发生在哪个阶段<br>首先tcp有两个队列：syn和accept队列，完成三次握手之后将会从syn队列移到accept队列，如果发现accpet队列已经满，则根据配置决定是否要应答RST报文。  </p>
<blockquote>
<p>Because of the 3-way handshake used by TCP, an incoming connection goes through an intermediate state SYN RECEIVED before it reaches the ESTABLISHED state and can be returned by the accept syscall to the application (see the part of the TCP state diagram reproduced above). This means that a TCP/IP stack has two options to implement the backlog queue for a socket in LISTEN state:  </p>
<ol>
<li>The implementation uses a single queue, the size of which is determined by the backlog argument of the listen syscall. When a SYN packet is received, it sends back a SYN/ACK packet and adds the connection to the queue. When the corresponding ACK is received, the connection changes its state to ESTABLISHED and becomes eligible for handover to the application. This means that the queue can contain connections in two different state: SYN RECEIVED and ESTABLISHED. Only connections in the latter state can be returned to the application by the accept syscall.</li>
<li>The implementation uses two queues, a SYN queue (or incomplete connection queue) and an accept queue (or complete connection queue). Connections in state SYN RECEIVED are added to the SYN queue and later moved to the accept queue when their state changes to ESTABLISHED, i.e. when the ACK packet in the 3-way handshake is received. As the name implies, the accept call is then implemented simply to consume connections from the accept queue. In this case, the backlog argument of the listen syscall determines the size of the accept queue.</li>
</ol>
</blockquote>
</li>
</ol>
<ol start="0">
<li>Epoll LT 、ET模式注意   <ul>
<li>LT工作模式的文件描述符，当epoll_wait 检测到其上有事件发生并且将此时间同时应用程序后，应用程序可以不立即处理该时间，这样当应用程序下次调用epoll_wait时，还会再次向应用程序通告此事件，直到改时间被处理。</li>
<li>ET工作木事的文件描述符，当epoll_wait检测到其上有时间发生并且此事件通知应用程序之后，<code>应用程序必须立即处理该事件</code>，因为后续的epoll_wait调用将<code>不再向应用程序通知</code>这一事件</li>
</ul>
</li>
</ol>
<ol start="0">
<li><p>Epoll EPOLLONESHOT事件<br>即使我们采用了ET模式，一个soket上的某个事件还是<code>可能被触发多次</code>，这在冰法程序中就会引发一个问题，比如一个线程或者进程在读取完某个socket上的数据后开始处理这些数据，<code>在数据的处理过程中该socket上又有新数据可读，此时另外一个线程被唤醒来读取这些新的数据</code>。于是就出现了两个线程同时操作一个socket的局面。我们希望的是一个socke连接在任一时刻都只能被一个线程处理。对于注册了EPOLLONESHOT事件的文件描述符，<code>操作系统最多触发其上的一个可读、可写或者异常事件，且只触发一次，除非我们使用epoll_ctl函数重置该文件描述符上注册的EPOLLONESHOT事件</code>。反过来，注册了EPOLLONESHOT事件的socket一旦被某个线程处理完毕，该线程就应该立即重置这个socket上的EPOLLONESHOT事件，以确保这个socket下次可读时，其EPOLLIN事件能被触发，进而让其他工作线程有机会继续处理这个socket。</p>
</li>
<li><p>I/O复用区别</p>
<p>系统调用|select | poll| epoll|<br>——-|——-|—–|——|<br>事件集合|用户通过3个参数分别传入感兴趣的可读可写及异常等事件，内核通过对这些参数的在线修改反馈其中的就绪事件这使得用户这次调用select都要重置这三个参数|统一处理所有事件类型因此秩序一个事件集参数。用户通过poll.events传入感兴趣的事件，内核通过修改pollfd.revents反馈其中就绪的事件|内核通过一个事件表直接管理用户感兴趣的所有事件因此每次调用epoll_wait时无须反复传入用户感兴趣的事件，epoll_wait系统调用的参数events仅用来反馈就绪的事件。|<br>应用程序索引就绪文件描述符的事件复杂度|O(n)|O(n)|O(1)|<br>最大支持文件描述符数|一般由最大值限制|65535|65535|<br>工作模式|LT|LT|LT\ET|<br>内核实现和工作效率|采用轮询方式来检测就绪事件，算法事件复杂度为O(n)|采用轮询方式来检测就绪事件，算法事件复杂度为O(n)|采用回调方式来检测就绪事件，算法事件复杂度为O(1)|</p>
</li>
</ol>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://leeqx.github.io/2019/03/22/tcpburn-压测/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Qinglin Li">
      <meta itemprop="description" content>
      <meta itemprop="image" content="https://avatars1.githubusercontent.com/u/931925?s=460&v=4">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="linux programer">
    </span>

    
      <header class="post-header">

        
        
          <h2 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2019/03/22/tcpburn-压测/" itemprop="url">未命名</a></h2>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2019-03-22T10:37:35+08:00">
                2019-03-22
              </time>
            

            

            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h2 id="安装"><a href="#安装" class="headerlink" title="安装"></a>安装</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">yum install libpcap libpcap-devel</span><br><span class="line"></span><br><span class="line">cd tcpcopy-0.9.9</span><br><span class="line">make clean</span><br><span class="line">sh autogen.sh</span><br><span class="line">./configure --enable-single --enable-pcap --enable-advanced</span><br><span class="line">make </span><br><span class="line">make install</span><br><span class="line"></span><br><span class="line">cd ../tcpburn</span><br><span class="line">make clean</span><br><span class="line"><span class="meta">#</span><span class="bash">./configure --single  </span></span><br><span class="line">./configure --single  --comet</span><br><span class="line">make</span><br><span class="line">make install</span><br></pre></td></tr></table></figure>
<h2 id="配置"><a href="#配置" class="headerlink" title="配置"></a>配置</h2><p>tcpburn 按照如下配置intercept 服务可以和tcpburn部署在同一台机器上，另外需要注意的是目标服务与tcpburn、intercept必须在同一个网段。<br>start.sh<br><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br></pre></td><td class="code"><pre><span class="line">killall intercept</span><br><span class="line">killall intercept</span><br><span class="line">rm ./logs/*.log*</span><br><span class="line"></span><br><span class="line">sleep 2</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash">intercept server</span></span><br><span class="line">intercept_server=11.aa.xx.80</span><br><span class="line">intercept_port=36524</span><br><span class="line"><span class="meta">#</span><span class="bash">our <span class="built_in">test</span> service</span></span><br><span class="line">target_server=11.aa.xx.79</span><br><span class="line">target_port=14000</span><br><span class="line">tcpdump_port=14000</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash">generate by tcpdump -s 0 port 80(your port) -i any -w 80.cap</span></span><br><span class="line">cap_file=client_access_2.0.cap</span><br><span class="line">client_net_range=62.135.250.x</span><br><span class="line">route_net=`echo $client_net_range|awk -F'.' '&#123;print $1"."$2".0.0"&#125;'`</span><br><span class="line">intercept_filter_net=`echo $client_net_range|awk -F'.' '&#123;print $1"."$2"."$3".0"&#125;'`</span><br><span class="line"></span><br><span class="line">echo "###################################################################################"</span><br><span class="line">echo "#intercept install on $intercept_server"</span><br><span class="line">echo "#target_server  install on $intercept_server ,such as(client_access\setlogic)"</span><br><span class="line">echo "#run this command on $target_server"</span><br><span class="line">echo "# route add -net $route_net netmask 255.255.0.0 gw $intercept_server"</span><br><span class="line">echo "# for delete runing:"</span><br><span class="line">echo "# route del -net $route_net netmask 255.255.0.0 gw $intercept_server"</span><br><span class="line">echo "#use tcpdump to capture packet on realserver,eg:"</span><br><span class="line">echo "#    tcpdump -s 0 port $tcpdump_port -i any -w $cap_file"</span><br><span class="line">echo "#"</span><br><span class="line">echo "# use this command to run tcpburn:"</span><br><span class="line">echo "#./tcpburn/objs/tcpburn -x $tcpdump_port-$target_server:$target_port -f $cap_file -s $intercept_server -p $intercept_port -u 100 -c $client_net_range"</span><br><span class="line">echo "###################################################################################"</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash">1. <span class="built_in">set</span> route on target server</span></span><br><span class="line"><span class="meta">#</span><span class="bash">eg:</span></span><br><span class="line"><span class="meta">#</span><span class="bash">Assume 65.135.233.161 is the IP address of the assistant server. We <span class="built_in">set</span> the following</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> route commands to route all responses to the 62.135.200.x<span class="string">'s clients to the assistant</span></span></span><br><span class="line"><span class="meta">#</span><span class="bash"> server.</span></span><br><span class="line"><span class="meta">#</span><span class="bash">add:</span></span><br><span class="line"><span class="meta">#</span><span class="bash">  route add -net 62.135.200.0 netmask 255.255.255.0 gw 65.135.233.161</span></span><br><span class="line"><span class="meta">#</span><span class="bash">delete:</span></span><br><span class="line"><span class="meta">#</span><span class="bash">  route  -net 62.135.200.0 netmask 255.255.255.0 gw 65.135.233.161</span></span><br><span class="line"><span class="meta">#</span><span class="bash">run this on targe sever:such as on  execute:</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> add route to intercept server(11.aa.xx.79)</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> net 62.135.0.0 must match the client ips at tcpburn option -c here is <span class="string">"62.135.250.x"</span></span></span><br><span class="line"><span class="meta">#</span><span class="bash">       route add -net `<span class="built_in">echo</span> <span class="variable">$client_net_range</span>|awk -F<span class="string">'.'</span> <span class="string">'&#123;print $1"."$2".0.0"&#125;'</span> netmask 255.255.0.0 gw <span class="variable">$intercept_server</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash">2.start intercept </span></span><br><span class="line"><span class="meta">#</span><span class="bash"><span class="string">"src port 80"</span> is match with tcpdump capture</span></span><br><span class="line"><span class="meta">#</span><span class="bash">eg:</span></span><br><span class="line"><span class="meta">#</span><span class="bash">intercept -i eth1 -F <span class="string">"src port 80 and net 62.135.250.0/24"</span> -b 11.aa.xx.79  -d</span></span><br><span class="line"><span class="meta">#</span><span class="bash">intercept -i eth1 -F <span class="string">"src port 80 "</span> -b 11.aa.xx.79  -d</span></span><br><span class="line">echo intercept -i eth1 -F \"src port $target_port and net $intercept_filter_net/24\"  -d</span><br><span class="line"><span class="meta">#</span><span class="bash">intercept -i eth1 -F <span class="string">"src port <span class="variable">$target_port</span> and net <span class="variable">$intercept_filter_net</span>/24"</span>  -d</span></span><br><span class="line">intercept -i eth1 -F "src port $target_port and net $intercept_filter_net/24"  -d</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash">3. start tcpburn to send request to target server throught intercept</span></span><br><span class="line"><span class="meta">#</span><span class="bash">eg:</span></span><br><span class="line"><span class="meta">#</span><span class="bash">Assume 65.135.233.160 is the IP address of the target server and 11.aa.xx.79 is the</span></span><br><span class="line"><span class="meta">#</span><span class="bash">internal IP address of the assistant server and 65.135.233.161 is the external IP </span></span><br><span class="line"><span class="meta">#</span><span class="bash">address of the assistant server.</span></span><br><span class="line"><span class="meta">#</span><span class="bash">  ./tcpburn -x 80-65.135.233.160:80 -f /path/to/80.pcap -s 11.aa.xx.79 </span></span><br><span class="line"><span class="meta">#</span><span class="bash">   -u 10000 -c 62.135.200.x</span></span><br><span class="line">sleep 5</span><br><span class="line">netstat -anp|grep $intercept_port</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash">file <span class="variable">$cap_file</span> is tcpdump: tcpdump -s 0 dst port <span class="variable">$tcpdump_port</span> -i any -c 1000000 -w <span class="variable">$cap_file</span></span></span><br><span class="line">echo ./tcpburn/objs/tcpburn -x $tcpdump_port-$target_server:$target_port -f $cap_file -s $intercept_server -p $intercept_port -u 100 -c $client_net_range</span><br><span class="line">echo "tcpburn log on /usr/local/tcpburn/logs"</span><br><span class="line">./tcpburn/objs/tcpburn -x $tcpdump_port-$target_server:$target_port -f $cap_file -s $intercept_server -p $intercept_port -u 100 -c $client_net_range</span><br></pre></td></tr></table></figure></p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://leeqx.github.io/2019/03/22/TCP-IP读书笔记/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Qinglin Li">
      <meta itemprop="description" content>
      <meta itemprop="image" content="https://avatars1.githubusercontent.com/u/931925?s=460&v=4">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="linux programer">
    </span>

    
      <header class="post-header">

        
        
          <h2 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2019/03/22/TCP-IP读书笔记/" itemprop="url">未命名</a></h2>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2019-03-22T10:37:35+08:00">
                2019-03-22
              </time>
            

            

            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>##TCP/IP 读书笔记</p>
<ol start="0">
<li>创建一个socket 内核中将会将以下三个结构体分配然后链接起来：<ol start="0">
<li>一个DTYPE_SOCKET类型的file结构</li>
<li>一个socket结构</li>
<li>一个inpcb结构</li>
</ol>
</li>
</ol>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://leeqx.github.io/2019/03/22/linux_进程死锁定位_端口无法连接/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Qinglin Li">
      <meta itemprop="description" content>
      <meta itemprop="image" content="https://avatars1.githubusercontent.com/u/931925?s=460&v=4">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="linux programer">
    </span>

    
      <header class="post-header">

        
        
          <h2 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2019/03/22/linux_进程死锁定位_端口无法连接/" itemprop="url">未命名</a></h2>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2019-03-22T10:37:35+08:00">
                2019-03-22
              </time>
            

            

            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h2 id="linux-进程死锁定位"><a href="#linux-进程死锁定位" class="headerlink" title="linux 进程死锁定位"></a>linux 进程死锁定位</h2><blockquote>
<p>最近定位一个服务问题时发现telnet某个端口，无法链接。无奈之下只能一步步排查。  </p>
</blockquote>
<ol start="0">
<li>端口是否存在<br>ss -l|grep LISTEN|grep 9999  </li>
<li>如果端口存在那么可以观察该端口上的recv-q send-q 如果是发生死锁一般情况下这两个队列只会增加（当然当服务处理过慢时也会导致包堆积）  <figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">Recv-Q Send-Q           Local Address:Port               Peer Address:Port   </span><br><span class="line">0      1024              *:5200                         *:*       </span><br><span class="line">```  </span><br><span class="line">0. 另外可以通过一下命令统计各类socket 状态的数据  </span><br><span class="line">  ```shell</span><br><span class="line">ss |awk 'BEGIN&#123;arr[""]=0&#125;&#123;arr[$1]++&#125;END&#123;for(i in arr) print i,arr[i]&#125;'</span><br><span class="line">LAST-ACK 1305</span><br><span class="line">ESTAB 341643</span><br><span class="line">State 1</span><br><span class="line">FIN-WAIT-1 7553</span><br><span class="line">CLOSING 3</span><br><span class="line">FIN-WAIT-2 908</span><br><span class="line">CLOSE-WAIT 60067</span><br></pre></td></tr></table></figure>
</li>
</ol>
<p>如果你的服务是多个进程那么，如果只是一个进程死锁，那么很容易就可以看出来该进程的cpu消耗时间应该小于其他进程，当然这个取决于进程的运行时间。下面的进程中，id=1903的进程就是疑似死锁问题。  </p>
  <figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">root      1901     1  0 11:09 ?        00:00:00 ./client -f ../conf/client.ini -d</span><br><span class="line">root      1902  1901 15 11:09 ?        00:31:55 ./client -f ../conf/client.ini -d</span><br><span class="line">root      1903  1901  1 11:09 ?        00:02:25 ./client -f ../conf/client.ini -d</span><br><span class="line">root      1904  1901 15 11:09 ?        00:31:19 ./client -f ../conf/client.ini -d</span><br><span class="line">root      1905  1901 15 11:09 ?        00:31:17 ./client -f ../conf/client.ini -d</span><br></pre></td></tr></table></figure>
<ol start="0">
<li>定位哪里死锁<br>经过一步步盘查之后，怀疑进程死锁，ok。最好的定位方法就是attach到进程，然后bt一下既可以看到进程hang在哪里。。。<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash">gdb attach 1903</span></span><br><span class="line"><span class="meta">#</span><span class="bash">0  0x00007f105892105e <span class="keyword">in</span> __lll_lock_wait_private () from /lib64/libc.so.6</span></span><br><span class="line"><span class="meta">#</span><span class="bash">1  0x00007f10588c6cad <span class="keyword">in</span> _L_lock_2164 () from /lib64/libc.so.6</span></span><br><span class="line"><span class="meta">#</span><span class="bash">2  0x00007f10588c6a67 <span class="keyword">in</span> __tz_convert () from /lib64/libc.so.6</span></span><br><span class="line"><span class="meta">#</span><span class="bash">3  0x00007f105890da5d <span class="keyword">in</span> __vsyslog_chk () from /lib64/libc.so.6</span></span><br><span class="line"><span class="meta">#</span><span class="bash">4  0x00007f105889948e <span class="keyword">in</span> __libc_message () from /lib64/libc.so.6</span></span><br><span class="line"><span class="meta">#</span><span class="bash">5  0x00007f105889ee66 <span class="keyword">in</span> malloc_printerr () from /lib64/libc.so.6</span></span><br><span class="line"><span class="meta">#</span><span class="bash">6  0x00007f10588c6909 <span class="keyword">in</span> tzset_internal () from /lib64/libc.so.6</span></span><br><span class="line"><span class="meta">#</span><span class="bash">7  0x00007f10588c6a89 <span class="keyword">in</span> __tz_convert () from /lib64/libc.so.6</span></span><br><span class="line"><span class="meta">#</span><span class="bash">8  0x00000000004c0917 <span class="keyword">in</span> shift_fd (lvl=1, fmt=0x55e308 <span class="string">"[%s][%d][%s]: [server] recv SIGSEGV.pid:%d!\n"</span>) at ../src/log_xx.cpp:95</span></span><br><span class="line"><span class="meta">#</span><span class="bash">9  write_log (lvl=1, fmt=0x55e308 <span class="string">"[%s][%d][%s]: [server] recv SIGSEGV.pid:%d!\n"</span>) at ../src/log_xx.cpp:138</span></span><br></pre></td></tr></table></figure>
</li>
</ol>
<p>上面这个问题导致是因为进程抛出了SEGV信号之后，在处理信号的方法中使用了非线程安全的localtime，而该方法中会枷锁。 </p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
  </section>

  
  <nav class="pagination">
    <a class="extend prev" rel="prev" href="/"><i class="fa fa-angle-left"></i></a><a class="page-number" href="/">1</a><span class="page-number current">2</span><a class="page-number" href="/page/3/">3</a><a class="page-number" href="/page/4/">4</a><a class="extend next" rel="next" href="/page/3/"><i class="fa fa-angle-right"></i></a>
  </nav>



          </div>
          


          

        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    
    <div class="sidebar-inner">

      

      

      <section class="site-overview-wrap sidebar-panel sidebar-panel-active">
        <div class="site-overview">
          <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
            
              <img class="site-author-image" itemprop="image" src="https://avatars1.githubusercontent.com/u/931925?s=460&v=4" alt="Qinglin Li">
            
              <p class="site-author-name" itemprop="name">Qinglin Li</p>
              <p class="site-description motion-element" itemprop="description"></p>
          </div>

          <nav class="site-state motion-element">

            
              <div class="site-state-item site-state-posts">
              
                <a href="/archives/">
              
                  <span class="site-state-item-count">33</span>
                  <span class="site-state-item-name">日志</span>
                </a>
              </div>
            

            

            

          </nav>

          

          
            <div class="links-of-author motion-element">
                
                  <span class="links-of-author-item">
                    <a href="https://github.com/leeqx" target="_blank" title="GitHub">
                      
                        <i class="fa fa-fw fa-github"></i>GitHub</a>
                  </span>
                
            </div>
          

          
          

          
          

          

        </div>
      </section>

      

      

    </div>
  </aside>


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright">&copy; 2015 &mdash; <span itemprop="copyrightYear">2019</span>
  <span class="with-love">
    <i class="fa fa-user"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">QingxinLi@2015</span>

  
</div>






  <div class="theme-info">主题 &mdash; <a class="theme-link" target="_blank" href="https://github.com/iissnan/hexo-theme-next">NexT.Muse</a> v5.1.4</div>




        







        
      </div>
    </footer>

    
      <div class="back-to-top">
        <i class="fa fa-arrow-up"></i>
        
      </div>
    

    

  </div>

  

<script type="text/javascript">
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>









  












  
  
    <script type="text/javascript" src="/lib/jquery/index.js?v=2.1.3"></script>
  

  
  
    <script type="text/javascript" src="/lib/fastclick/lib/fastclick.min.js?v=1.0.6"></script>
  

  
  
    <script type="text/javascript" src="/lib/jquery_lazyload/jquery.lazyload.js?v=1.9.7"></script>
  

  
  
    <script type="text/javascript" src="/lib/velocity/velocity.min.js?v=1.2.1"></script>
  

  
  
    <script type="text/javascript" src="/lib/velocity/velocity.ui.min.js?v=1.2.1"></script>
  

  
  
    <script type="text/javascript" src="/lib/fancybox/source/jquery.fancybox.pack.js?v=2.1.5"></script>
  


  


  <script type="text/javascript" src="/js/src/utils.js?v=5.1.4"></script>

  <script type="text/javascript" src="/js/src/motion.js?v=5.1.4"></script>



  
  

  

  


  <script type="text/javascript" src="/js/src/bootstrap.js?v=5.1.4"></script>



  


  




	





  





  







<!-- LOCAL: You can save these files to your site and update links -->
    
        
        <link rel="stylesheet" href="https://aimingoo.github.io/gitmint/style/default.css">
        <script src="https://aimingoo.github.io/gitmint/dist/gitmint.browser.js"></script>
    
<!-- END LOCAL -->

    

    







  





  

  

  
<script>
(function(){
    var bp = document.createElement('script');
    var curProtocol = window.location.protocol.split(':')[0];
    if (curProtocol === 'https') {
        bp.src = 'https://zz.bdstatic.com/linksubmit/push.js';        
    }
    else {
        bp.src = 'http://push.zhanzhang.baidu.com/push.js';
    }
    var s = document.getElementsByTagName("script")[0];
    s.parentNode.insertBefore(bp, s);
})();
</script>


  
  

  

  

  

</body>
</html>
